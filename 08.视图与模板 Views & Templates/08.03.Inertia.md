# Inertia

**[Inertia](https://inertiajs.com/)** æ˜¯ä¸€ç§ä¸æ¡†æ¶æ— å…³çš„æ–¹å¼ï¼Œç”¨äºåˆ›å»ºå•é¡µåº”ç”¨ç¨‹åº (SPA)ï¼Œè€Œæ— éœ€ç°ä»£ SPA çš„å¤æ‚æ€§ã€‚

å®ƒæ˜¯ä¼ ç»ŸæœåŠ¡å™¨æ¸²æŸ“åº”ç”¨ç¨‹åºï¼ˆå¸¦æœ‰æ¨¡æ¿å¼•æ“ï¼‰å’Œç°ä»£ SPAï¼ˆå¸¦æœ‰å®¢æˆ·ç«¯è·¯ç”±å’ŒçŠ¶æ€ç®¡ç†ï¼‰ä¹‹é—´çš„ç»ä½³ä¸­é—´åœ°å¸¦ã€‚

ä½¿ç”¨ Inertia å°†å…è®¸æ‚¨ä½¿ç”¨è‡ªå·±å–œæ¬¢çš„å‰ç«¯æ¡†æ¶ï¼ˆVue.jsã€Reactã€Svelte æˆ– Solid.jsï¼‰åˆ›å»º SPAï¼Œè€Œæ— éœ€åˆ›å»ºå•ç‹¬çš„ APIã€‚

:::codegroup

```ts
// title: app/controllers/users_controller.ts
import type { HttpContext } from '@adonisjs/core/http'

export default class UsersController {
Â  async index({ inertia }: HttpContext) {
Â  Â  const users = await User.all()

Â  Â  // æ¸²æŸ“ 'users/index' å‰ç«¯ç»„ä»¶ï¼Œå¹¶ä¼ é€’ users æ•°æ®
Â  Â  return inertia.render('users/index', { users })
Â  }
}
```

```vue
// title: inertia/pages/users/index.vue
<script setup lang="ts">
import { Link, Head } from '@inertiajs/vue3'

// å®šä¹‰ç»„ä»¶æ¥æ”¶çš„ props
defineProps<{
Â  users: SerializedUser[]
}>()
</script>

<template>
Â  <Head title="Users" />

Â  <div v-for="user in users" :key="user.id">
Â  Â  <Link :href="`/users/${user.id}`">
Â  Â  Â  {{ user.name }}
Â  Â  </Link>
Â  Â  <div>{{ user.email }}</div>
Â  </div>
</template>
```

:::

-----

## å®‰è£… (Installation)

:::note
æ‚¨æ­£åœ¨å¼€å§‹ä¸€ä¸ªæ–°é¡¹ç›®å¹¶æƒ³ä½¿ç”¨ Inertia å—ï¼ŸæŸ¥çœ‹ [Inertia å¯åŠ¨å¥—ä»¶](https://docs.adonisjs.com/guides/getting-started/installation#inertia-starter-kit)ã€‚
:::

ä» npm æ³¨å†Œè¡¨å®‰è£…è¯¥åŒ…ï¼š

```sh
// title: npm
npm i @adonisjs/inertia
```

å®Œæˆåï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥é…ç½®è¯¥åŒ…ã€‚

```sh
node ace configure @adonisjs/inertia
```

:::disclosure{title="æŸ¥çœ‹ configure å‘½ä»¤æ‰§è¡Œçš„æ­¥éª¤"}

1.  åœ¨ `adonisrc.ts` æ–‡ä»¶ä¸­æ³¨å†Œä»¥ä¸‹æœåŠ¡æä¾›è€…å’Œå‘½ä»¤ã€‚
    ```ts
    {
      providers: [
        // ...å…¶ä»–æä¾›è€…
        () => import('@adonisjs/inertia/inertia_provider')
      ]
    }
    ```
2.  åœ¨ `start/kernel.ts` æ–‡ä»¶ä¸­æ³¨å†Œä»¥ä¸‹ä¸­é—´ä»¶ã€‚
    ```ts
    router.use([() => import('@adonisjs/inertia/inertia_middleware')])
    ```
3.  åˆ›å»º `config/inertia.ts` æ–‡ä»¶ã€‚
4.  å°†ä¸€äº›å­˜æ ¹æ–‡ä»¶å¤åˆ¶åˆ°æ‚¨çš„åº”ç”¨ç¨‹åºä¸­ï¼Œä»¥å¸®åŠ©æ‚¨å¿«é€Ÿå…¥é—¨ã€‚æ¯ä¸ªå¤åˆ¶çš„æ–‡ä»¶éƒ½é€‚åº”äºå…ˆå‰é€‰æ‹©çš„å‰ç«¯æ¡†æ¶ã€‚
    1.  åˆ›å»º `./resources/views/inertia_layout.edge` æ–‡ä»¶ï¼Œç”¨äºæ¸²æŸ“å¼•å¯¼ Inertia çš„ HTML é¡µé¢ã€‚
    2.  åˆ›å»º `./inertia/css/app.css` æ–‡ä»¶ï¼ŒåŒ…å«æ ·å¼åŒ– `inertia_layout.edge` è§†å›¾æ‰€éœ€çš„å†…å®¹ã€‚
    3.  åˆ›å»º `./inertia/tsconfig.json` æ–‡ä»¶ï¼Œä»¥åŒºåˆ†æœåŠ¡å™¨ç«¯å’Œå®¢æˆ·ç«¯çš„ TypeScript é…ç½®ã€‚
    4.  åˆ›å»º `./inertia/app/app.ts` ç”¨äºå¼•å¯¼ Inertia å’Œæ‚¨çš„å‰ç«¯æ¡†æ¶ã€‚
    5.  åˆ›å»º `./inertia/pages/home.{tsx|vue|svelte}` æ–‡ä»¶æ¥æ¸²æŸ“åº”ç”¨ç¨‹åºçš„ä¸»é¡µã€‚
    6.  åˆ›å»º `./inertia/pages/server_error.{tsx|vue|svelte}` å’Œ `./inertia/pages/not_found.{tsx|vue|svelte}` æ–‡ä»¶æ¥æ¸²æŸ“é”™è¯¯é¡µé¢ã€‚
    7.  åœ¨ `vite.config.ts` æ–‡ä»¶ä¸­æ·»åŠ æ­£ç¡®çš„ vite æ’ä»¶ä»¥ç¼–è¯‘æ‚¨çš„å‰ç«¯æ¡†æ¶ã€‚
    8.  åœ¨ `start/routes.ts` æ–‡ä»¶ä¸­åœ¨ `/` å¤„æ·»åŠ ä¸€ä¸ªç¤ºä¾‹è·¯ç”±ï¼Œä»¥ä½¿ç”¨ Inertia æ¸²æŸ“ä¸»é¡µã€‚
5.  æ ¹æ®é€‰å®šçš„å‰ç«¯æ¡†æ¶å®‰è£…åŒ…ã€‚

:::

å®Œæˆåï¼Œæ‚¨åº”è¯¥å‡†å¤‡å¥½åœ¨ AdonisJS åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨ Inertia äº†ã€‚å¯åŠ¨å¼€å‘æœåŠ¡å™¨ï¼Œå¹¶è®¿é—® `localhost:3333` ä»¥æŸ¥çœ‹ä½¿ç”¨ Inertia å’Œæ‚¨é€‰æ‹©çš„å‰ç«¯æ¡†æ¶æ¸²æŸ“çš„ä¸»é¡µã€‚

:::note
**é˜…è¯» [Inertia å®˜æ–¹æ–‡æ¡£](https://inertiajs.com/)**ã€‚

Inertia æ˜¯ä¸€ä¸ªä¸åç«¯æ— å…³çš„åº“ã€‚æˆ‘ä»¬åªæ˜¯åˆ›å»ºäº†ä¸€ä¸ªé€‚é…å™¨ä»¥ä½¿å…¶ä¸ AdonisJS é…åˆä½¿ç”¨ã€‚åœ¨é˜…è¯»æœ¬æ–‡æ¡£ä¹‹å‰ï¼Œæ‚¨åº”è¯¥ç†Ÿæ‚‰ Inertia çš„æ¦‚å¿µã€‚

**æˆ‘ä»¬ä»…åœ¨æœ¬æ–‡æ¡£ä¸­ä»‹ç» AdonisJS ç‰¹å®šçš„éƒ¨åˆ†ã€‚**
:::

-----

## å®¢æˆ·ç«¯å…¥å£ç‚¹ (Client-side entrypoint)

å¦‚æœæ‚¨ä½¿ç”¨äº† `configure` æˆ– `add` å‘½ä»¤ï¼Œè¯¥åŒ…å·²ç»åœ¨ `inertia/app/app.ts` åˆ›å»ºäº†ä¸€ä¸ªå…¥å£ç‚¹æ–‡ä»¶ï¼Œå› æ­¤æ‚¨å¯ä»¥è·³è¿‡æ­¤æ­¥éª¤ã€‚

åŸºæœ¬ä¸Šï¼Œæ­¤æ–‡ä»¶å°†æ˜¯æ‚¨å‰ç«¯åº”ç”¨ç¨‹åºçš„ä¸»å…¥å£ç‚¹ï¼Œå°†ç”¨äºå¼•å¯¼ Inertia å’Œæ‚¨çš„å‰ç«¯æ¡†æ¶ã€‚æ­¤æ–‡ä»¶åº”è¯¥æ˜¯æ‚¨çš„æ ¹ Edge æ¨¡æ¿ä½¿ç”¨ `@vite` æ ‡ç­¾åŠ è½½çš„å…¥å£ç‚¹ã€‚

ï¼ˆæ­¤å¤„çœç•¥äº† Vue, React, Svelte, Solid çš„å…¥å£ç‚¹ä»£ç ç¤ºä¾‹ï¼Œå¦‚éœ€è¯·å‘ŠçŸ¥ï¼‰

è¯¥æ–‡ä»¶çš„ä½œç”¨æ˜¯åˆ›å»º Inertia åº”ç”¨ç¨‹åºå¹¶è§£æé¡µé¢ç»„ä»¶ã€‚å½“æ‚¨ä½¿ç”¨ `inertia.render` æ—¶ç¼–å†™çš„é¡µé¢ç»„ä»¶å°†è¢«ä¼ é€’ç»™ `resolve` å‡½æ•°ï¼Œè¯¥å‡½æ•°çš„ä½œç”¨æ˜¯è¿”å›éœ€è¦æ¸²æŸ“çš„ç»„ä»¶ã€‚

-----

## æ¸²æŸ“é¡µé¢ (Rendering pages)

åœ¨é…ç½®åŒ…æ—¶ï¼Œ`inertia_middleware` å·²åœ¨ `start/kernel.ts` æ–‡ä»¶ä¸­æ³¨å†Œã€‚è¯¥ä¸­é—´ä»¶è´Ÿè´£åœ¨ [`HttpContext`](https://www.google.com/search?q=../concepts/http_context.md) ä¸Šè®¾ç½® `inertia` å¯¹è±¡ã€‚

è¦ä½¿ç”¨ Inertia æ¸²æŸ“è§†å›¾ï¼Œè¯·ä½¿ç”¨ **`inertia.render` æ–¹æ³•**ã€‚è¯¥æ–¹æ³•æ¥å—**è§†å›¾åç§°**å’Œè¦ä½œä¸º **props** ä¼ é€’ç»™ç»„ä»¶çš„**æ•°æ®**ã€‚

```ts
// title: app/controllers/home_controller.ts
export default class HomeController {
Â  async index({ inertia }: HttpContext) {
Â  Â  // æ¸²æŸ“ 'home' ç»„ä»¶ï¼Œå¹¶ä¼ é€’ user æ•°æ®
Â  Â  return inertia.render('home', { user: { name: 'julien' } })
Â  }
}
```

æ‚¨çœ‹åˆ°ä¼ é€’ç»™ `inertia.render` æ–¹æ³•çš„ `home` äº†å—ï¼Ÿå®ƒåº”è¯¥æ˜¯ç›¸å¯¹äº `inertia/pages` ç›®å½•çš„ç»„ä»¶æ–‡ä»¶è·¯å¾„ã€‚æˆ‘ä»¬åœ¨è¿™é‡Œæ¸²æŸ“ `inertia/pages/home.(vue,tsx)` æ–‡ä»¶ã€‚

æ‚¨çš„å‰ç«¯ç»„ä»¶å°†æ¥æ”¶ `user` å¯¹è±¡ä½œä¸º propã€‚

ï¼ˆæ­¤å¤„çœç•¥äº† Vue, React, Svelte, Solid çš„ç»„ä»¶æ¥æ”¶ props çš„ä»£ç ç¤ºä¾‹ï¼Œå¦‚éœ€è¯·å‘ŠçŸ¥ï¼‰

å°±è¿™ä¹ˆç®€å•ã€‚

:::warning
åœ¨å°†æ•°æ®ä¼ é€’åˆ°å‰ç«¯æ—¶ï¼Œ**ä¸€åˆ‡éƒ½ä¼šè¢«åºåˆ—åŒ–ä¸º JSON**ã€‚ä¸è¦æœŸæœ›ä¼ é€’æ¨¡å‹å®ä¾‹ã€æ—¥æœŸæˆ–å…¶ä»–å¤æ‚å¯¹è±¡ã€‚
:::

### æ ¹ Edge æ¨¡æ¿ (Root Edge template)

æ ¹æ¨¡æ¿æ˜¯ä¸€ä¸ªå¸¸è§„çš„ Edge æ¨¡æ¿ï¼Œå°†åœ¨æ‚¨çš„åº”ç”¨ç¨‹åºçš„ç¬¬ä¸€æ¬¡é¡µé¢è®¿é—®æ—¶åŠ è½½ã€‚æ‚¨åº”è¯¥åœ¨è¿™é‡ŒåŒ…å« CSS å’Œ Javascript æ–‡ä»¶ï¼Œä»¥åŠåŒ…å« **`@inertia` æ ‡ç­¾**ã€‚å…¸å‹çš„æ ¹æ¨¡æ¿å¦‚ä¸‹æ‰€ç¤ºï¼š

:::codegroup

```edge
// title: Vue
<!DOCTYPE html>
<html>

<head>
Â  <meta charset="utf-8">
Â  <meta name="viewport" content="width=device-width, initial-scale=1">
Â  <title inertia>AdonisJS x Inertia</title>

Â  @inertiaHead()
Â  @vite(['inertia/app/app.ts', `inertia/pages/${page.component}.vue`])
</head>

<body>
Â  @inertia()
</body>

</html>
```

ï¼ˆæ­¤å¤„çœç•¥äº† React, Svelte, Solid çš„æ ¹æ¨¡æ¿ç¤ºä¾‹ï¼‰
:::

æ‚¨å¯ä»¥åœ¨ `config/inertia.ts` æ–‡ä»¶ä¸­é…ç½®æ ¹æ¨¡æ¿è·¯å¾„ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå®ƒå‡å®šæ‚¨çš„æ¨¡æ¿ä½äº `resources/views/inertia_layout.edge`ã€‚

```ts
import { defineConfig } from '@adonisjs/inertia'

export default defineConfig({
Â  // ç›¸å¯¹äº `resources/views` ç›®å½•çš„æ ¹æ¨¡æ¿è·¯å¾„
Â  rootView: 'app_root',Â 
})
```

å¦‚æœéœ€è¦ï¼Œæ‚¨å¯ä»¥å°†å‡½æ•°ä¼ é€’ç»™ `rootView` å±æ€§ï¼Œä»¥åŠ¨æ€å†³å®šåº”ä½¿ç”¨å“ªä¸ªæ ¹æ¨¡æ¿ã€‚

### æ ¹æ¨¡æ¿æ•°æ® (Root template data)

æ‚¨å¯èƒ½å¸Œæœ›ä¸æ ¹ Edge æ¨¡æ¿å…±äº«æ•°æ®ã€‚ä¾‹å¦‚ï¼Œç”¨äºæ·»åŠ å…ƒæ ‡é¢˜æˆ–å¼€æ”¾å›¾è°±æ ‡ç­¾ã€‚æ‚¨å¯ä»¥é€šè¿‡ä½¿ç”¨ `inertia.render` æ–¹æ³•çš„**ç¬¬ 3 ä¸ªå‚æ•°**æ¥å®ç°ï¼š

```ts
// title: app/controllers/posts_controller.ts
export default class PostsController {
Â  async index({ inertia }: HttpContext) {
Â  Â  return inertia.render('posts/details', post, {
Â  Â  Â  // ä¼ é€’ç»™æ ¹æ¨¡æ¿çš„æ•°æ®
Â  Â  Â  title: post.title,
Â  Â  Â  description: post.description
Â  Â  })
Â  }
}
```

`title` å’Œ `description` ç°åœ¨å°†åœ¨æ ¹ Edge æ¨¡æ¿ä¸­å¯ç”¨ï¼š

```edge
// title: resources/views/root.edge
<html>
Â  <title>{{ title }}</title>
Â  <meta name="description" content="{{ description }}">

Â  <body>
Â  Â  @inertia()
Â  </body>
</html
```

-----

## é‡å®šå‘ (Redirects)

åœ¨ AdonisJS ä¸­åº”è¯¥è¿™æ ·åšï¼š

```ts
export default class UsersController {
Â  async store({ response }: HttpContext) {
Â  Â  await User.create(request.body())

Â  Â  // ğŸ‘‡ æ‚¨å¯ä»¥ä½¿ç”¨æ ‡å‡†çš„ AdonisJS é‡å®šå‘
Â  Â  return response.redirect().toRoute('users.index')
Â  }

Â  async externalRedirect({ inertia }: HttpContext) {
Â  Â  // ğŸ‘‡ æˆ–è€…ä½¿ç”¨ inertia.location è¿›è¡Œå¤–éƒ¨é‡å®šå‘
Â  Â  return inertia.location('https://adonisjs.com')
Â  }
}
```

æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜… [å®˜æ–¹æ–‡æ¡£](https://inertiajs.com/redirects)ã€‚

-----

## ä¸æ‰€æœ‰è§†å›¾å…±äº«æ•°æ® (Sharing data with all views)

æœ‰æ—¶ï¼Œæ‚¨å¯èƒ½éœ€è¦è·¨å¤šä¸ªè§†å›¾å…±äº«ç›¸åŒçš„æ•°æ®ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬ä¸æ‰€æœ‰è§†å›¾å…±äº«å½“å‰ç”¨æˆ·ä¿¡æ¯ã€‚è¿™å¯ä»¥é€šè¿‡ä¸¤ç§æ–¹å¼è§£å†³ã€‚

### `sharedData`

åœ¨ `config/inertia.ts` æ–‡ä»¶ä¸­ï¼Œæ‚¨å¯ä»¥å®šä¹‰ä¸€ä¸ª `sharedData` å¯¹è±¡ã€‚æ­¤å¯¹è±¡å…è®¸æ‚¨å®šä¹‰åº”ä¸æ‰€æœ‰è§†å›¾å…±äº«çš„æ•°æ®ã€‚

```ts
import { defineConfig } from '@adonisjs/inertia'

export default defineConfig({
Â  sharedData: {
Â  Â  appName: 'My App', // ğŸ‘ˆ è¿™å°†åœ¨æ‰€æœ‰è§†å›¾ä¸­å¯ç”¨
Â  Â  user: (ctx) => ctx.auth?.user, // ğŸ‘ˆ é™å®šäºå½“å‰è¯·æ±‚
Â  },
})
```

### ä»ä¸­é—´ä»¶å…±äº« (Share from a middleware)

æœ‰æ—¶ï¼Œä»ä¸­é—´ä»¶å…±äº«æ•°æ®å¯èƒ½æ¯” `config/inertia.ts` æ–‡ä»¶æ›´æ–¹ä¾¿ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ **`inertia.share` æ–¹æ³•**æ¥å®ç°ï¼š

```ts
export default class MyMiddleware {
Â  async handle({ inertia, auth }: HttpContext, next: NextFn) {
Â  Â  inertia.share({
Â  Â  Â  appName: 'My App',
Â  Â  Â  user: (ctx) => ctx.auth?.user
Â  Â  })
Â  }
}
```

-----

## éƒ¨åˆ†é‡è½½å’Œå»¶è¿Ÿæ•°æ®è¯„ä¼° (Partial reloads & Lazy data evaluation)

é¦–å…ˆé˜…è¯» [å®˜æ–¹æ–‡æ¡£](https://inertiajs.com/partial-reloads) ä»¥äº†è§£ä»€ä¹ˆæ˜¯éƒ¨åˆ†é‡è½½åŠå…¶å·¥ä½œåŸç†ã€‚

å…³äºå»¶è¿Ÿæ•°æ®è¯„ä¼°ï¼Œä»¥ä¸‹æ˜¯å®ƒåœ¨ AdonisJS ä¸­çš„å·¥ä½œæ–¹å¼ï¼š

```ts
export default class UsersController {
Â  async index({ inertia }: HttpContext) {
Â  Â  return inertia.render('users/index', {
Â  Â  Â  // å§‹ç»ˆåœ¨é¦–æ¬¡è®¿é—®æ—¶åŒ…å«ã€‚
Â  Â  Â  // å¯é€‰åœ°åœ¨éƒ¨åˆ†é‡è½½æ—¶åŒ…å«ã€‚
Â  Â  Â  // å§‹ç»ˆè¯„ä¼°
Â  Â  Â  users: await User.all(),

Â  Â  Â  // å§‹ç»ˆåœ¨é¦–æ¬¡è®¿é—®æ—¶åŒ…å«ã€‚
Â  Â  Â  // å¯é€‰åœ°åœ¨éƒ¨åˆ†é‡è½½æ—¶åŒ…å«ã€‚
Â  Â  Â  // ä»…åœ¨éœ€è¦æ—¶è¯„ä¼°
Â  Â  Â  users: () => User.all(),

Â  Â  Â  // ä»ä¸åœ¨é¦–æ¬¡è®¿é—®æ—¶åŒ…å«ã€‚
Â  Â  Â  // å¯é€‰åœ°åœ¨éƒ¨åˆ†é‡è½½æ—¶åŒ…å«ã€‚
Â  Â  Â  // ä»…åœ¨éœ€è¦æ—¶è¯„ä¼°
Â  Â  Â  users: inertia.optional(() => User.all())
Â  Â  }),
Â  }
}
```

-----

## ç±»å‹å…±äº« (Types sharing)

é€šå¸¸ï¼Œæ‚¨å¸Œæœ›å…±äº«ä¼ é€’ç»™å‰ç«¯é¡µé¢ç»„ä»¶çš„æ•°æ®ç±»å‹ã€‚ä¸€ç§ç®€å•çš„æ–¹æ³•æ˜¯ä½¿ç”¨ **`InferPageProps` ç±»å‹**ã€‚

```ts
// title: app/controllers/users_controller.ts
export class UsersController {
Â  index() {
Â  Â  return inertia.render('users/index', {
Â  Â  Â  users: [ { id: 1, name: 'julien' } ]
Â  Â  })
Â  }
}
```

```tsx
// title: inertia/pages/users/index.tsx
import { InferPageProps } from '@adonisjs/inertia/types'
import type { UsersController } from '../../controllers/users_controller.ts'

export function UsersPage(
Â  // ğŸ‘‡ å®ƒå°†æ ¹æ®æ‚¨åœ¨æ§åˆ¶å™¨ä¸­ä¼ é€’ç»™ inertia.render çš„å†…å®¹æ­£ç¡®æ¨æ–­ç±»å‹
Â  props: InferPageProps<UsersController, 'index'>
) {
Â  // ...
}
```

### å¼•ç”¨æŒ‡ä»¤ (Reference Directives)

ç”±äºæ‚¨çš„ Inertia åº”ç”¨ç¨‹åºæ˜¯ä¸€ä¸ªå•ç‹¬çš„ TypeScript é¡¹ç›®ï¼Œæ‚¨å¯èƒ½éœ€è¦ä½¿ç”¨ [å¼•ç”¨æŒ‡ä»¤](https://www.typescriptlang.org/docs/handbook/triple-slash-directives.html#-reference-path-) æ¥å¸®åŠ© TypeScript ç†è§£æŸäº›ç±»å‹ã€‚

åœ¨ `inertia/app/app.ts` æ–‡ä»¶ä¸­æ·»åŠ ä»¥ä¸‹è¡Œï¼š

```ts
/// <reference path="../../adonisrc.ts" />
```

### å…±äº« Props (Shared Props)

ä¸ºäº†åœ¨ç»„ä»¶ä¸­è·å¾— [å…±äº«æ•°æ®](https://www.google.com/search?q=%23sharing-data-with-all-views) çš„ç±»å‹ï¼Œè¯·ç¡®ä¿åœ¨ `config/inertia.ts` æ–‡ä»¶ä¸­æ‰§è¡Œäº†æ¨¡å—å¢å¼ºï¼š

```ts
// file: config/inertia.ts
// ... config definition

declare module '@adonisjs/inertia/types' {
Â  export interface SharedProps extends InferSharedProps<typeof inertiaConfig> {
Â  Â  // æ‰‹åŠ¨æ·»åŠ å…±äº« props
Â  Â  propsSharedFromAMiddleware: number;
Â  }
}
```

-----

## CSRF

å¦‚æœæ‚¨ä¸ºåº”ç”¨ç¨‹åºå¯ç”¨äº† [CSRF ä¿æŠ¤](https://www.google.com/search?q=../security/securing_ssr_applications.md%23csrf-protection)ï¼Œè¯·åœ¨ `config/shield.ts` æ–‡ä»¶ä¸­å¯ç”¨ `enableXsrfCookie` é€‰é¡¹ã€‚

å¯ç”¨æ­¤é€‰é¡¹å°†ç¡®ä¿ `XSRF-TOKEN` cookie è®¾ç½®åœ¨å®¢æˆ·ç«¯ï¼Œå¹¶åœ¨æ¯æ¬¡è¯·æ±‚æ—¶å‘é€å›æœåŠ¡å™¨ã€‚

-----

## èµ„äº§ç‰ˆæœ¬æ§åˆ¶ (Asset versioning)

å½“é‡æ–°éƒ¨ç½²æ‚¨çš„åº”ç”¨ç¨‹åºæ—¶ï¼Œæ‚¨çš„ç”¨æˆ·åº”å§‹ç»ˆè·å¾—æœ€æ–°ç‰ˆæœ¬çš„å®¢æˆ·ç«¯èµ„äº§ã€‚è¿™æ˜¯ Inertia åè®®å’Œ AdonisJS å¼€ç®±å³ç”¨çš„æ”¯æŒã€‚

é»˜è®¤æƒ…å†µä¸‹ï¼Œ`@adonisjs/inertia` åŒ…å°†è®¡ç®— `public/assets/manifest.json` æ–‡ä»¶çš„å“ˆå¸Œå€¼ï¼Œå¹¶å°†å…¶ç”¨ä½œèµ„äº§çš„ç‰ˆæœ¬ã€‚

å¦‚æœæ‚¨æƒ³è°ƒæ•´æ­¤è¡Œä¸ºï¼Œå¯ä»¥ç¼–è¾‘ `config/inertia.ts` æ–‡ä»¶ä¸­çš„ `assetsVersion` å±æ€§ã€‚

-----

## SSR (Server-Side Rendering)

### å¯ç”¨ SSR

[Inertia å¯åŠ¨å¥—ä»¶](https://www.google.com/search?q=../getting_started/installation.md%23starter-kits) å¼€ç®±å³ç”¨åœ°æ”¯æŒæœåŠ¡å™¨ç«¯æ¸²æŸ“ (SSR)ã€‚

å¦‚æœæ‚¨çš„åº”ç”¨ç¨‹åºæ²¡æœ‰å¯ç”¨ SSRï¼Œæ‚¨å¯ä»¥ç¨åæŒ‰ç…§ä»¥ä¸‹æ­¥éª¤å¯ç”¨å®ƒï¼š

1.  **æ·»åŠ æœåŠ¡å™¨å…¥å£ç‚¹**ï¼šåœ¨ `inertia/app/ssr.ts` åˆ›å»ºä¸€ä¸ªæœåŠ¡å™¨å…¥å£ç‚¹ã€‚
2.  **æ›´æ–°é…ç½®æ–‡ä»¶**ï¼šåœ¨ `config/inertia.ts` æ–‡ä»¶ä¸­æ›´æ–° `ssr` å±æ€§ä»¥å¯ç”¨å®ƒã€‚
3.  **æ›´æ–° Vite é…ç½®**ï¼šåœ¨ `vite.config.ts` æ–‡ä»¶ä¸­æ›´æ–°æœåŠ¡å™¨å…¥å£ç‚¹çš„è·¯å¾„ã€‚

### SSR å…è®¸åˆ—è¡¨ (SSR Allowlist)

æ‚¨å¯ä»¥åœ¨ `config/inertia.ts` æ–‡ä»¶ä¸­é…ç½® `ssr.pages` å±æ€§ï¼Œä»¥å†³å®šå“ªäº›é¡µé¢åº”è¯¥åœ¨æœåŠ¡å™¨ä¸Šæ¸²æŸ“ã€‚

```ts
export default defineConfig({
Â  ssr: {
Â  Â  enabled: true,
Â  Â  pages: ['home'] // ä»…æ¸²æŸ“ 'home' é¡µé¢
Â  }
})
```

-----

## æµ‹è¯• (Testing)

æ‚¨å¯ä»¥ä½¿ç”¨ [Browser Client](https://docs.adonisjs.com/guides/browser-tests) è¿›è¡Œç«¯åˆ°ç«¯æµ‹è¯•ï¼Œæˆ–ä½¿ç”¨ [Vitest](https://vitest.dev) è¿›è¡Œå•å…ƒæµ‹è¯•ã€‚

æ­¤å¤–ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ Japa ä¸­çš„æµ‹è¯•è¾…åŠ©å‡½æ•°æ¥æµ‹è¯•æ‚¨çš„ Inertia ç«¯ç‚¹ã€‚

1.  åœ¨ `tests/bootstrap.ts` ä¸­é…ç½® `inertiaApiClient` æ’ä»¶ã€‚
2.  åœ¨æµ‹è¯•ä¸­ä½¿ç”¨ **`withInertia()`** å‘èµ·è¯·æ±‚ã€‚
3.  ä½¿ç”¨ **`assertInertiaComponent()`** å’Œ **`assertInertiaProps()`** è¿›è¡Œæ–­è¨€ã€‚

<!-- end list -->

```ts
test('returns correct data', async ({ client }) => {
Â  const response = await client.get('/home').withInertia()

Â  response.assertStatus(200)
Â  response.assertInertiaComponent('home/main')
Â  response.assertInertiaProps({ user: { name: 'julien' } })
})
```

-----

## å¸¸è§é—®é¢˜ (FAQ)

### ä¸ºä»€ä¹ˆæ›´æ–°å‰ç«¯ä»£ç æ—¶æœåŠ¡å™¨ä¸æ–­é‡æ–°åŠ è½½ï¼Ÿ

æ‚¨éœ€è¦åœ¨æ ¹ `tsconfig.json` æ–‡ä»¶ä¸­æ’é™¤ `inertia/**/*`ï¼Œä»¥é¿å… HMR é‡æ–°åŠ è½½æœåŠ¡å™¨ã€‚

```jsonc
{
Â  "exclude": ["inertia/**/*"]
}
```

### ä¸ºä»€ä¹ˆæˆ‘çš„ç”Ÿäº§æ„å»ºä¸å·¥ä½œï¼Ÿ

å¸¸è§é—®é¢˜æ˜¯åœ¨è¿è¡Œç”Ÿäº§æ„å»ºæ—¶å¿˜è®°è®¾ç½® `NODE_ENV=production`ã€‚

```shell
NODE_ENV=production node build/server.js
```

### `Top-level await is not available...`

è¿™é€šå¸¸æ„å‘³ç€æ‚¨æ­£åœ¨å°†åç«¯ä»£ç å¯¼å…¥åˆ°å‰ç«¯ä»£ç ä¸­ã€‚è¯·ç¡®ä¿ä»…é€šè¿‡ `import type` å¯¼å…¥åç«¯ç±»å‹ã€‚

```ts
// âœ… æ­£ç¡®
import type { User } from '#models/user'

// âŒ é”™è¯¯
import { User } from '#models/user'
```