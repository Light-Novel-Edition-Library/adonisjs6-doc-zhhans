# 调试 (Debugging)

在本指南中，我们将探讨调试 AdonisJS 应用程序的多种方法，包括使用 **VSCode 调试器**、使用 **Dump and Die** 以及查看**框架的调试日志**。

-----

## 使用 VSCode 调试器调试 (Debug using the VSCode debugger)

使用 VSCode 调试器调试 AdonisJS 应用程序非常简单。您只需要创建一个 **`.vscode/launch.json` 文件**并使用 **Node.js 调试器**即可。

在以下示例中，我们定义了一个配置，用于在调试模式下启动 AdonisJS 开发服务器，然后将 VSCode 调试器附加到它。

另请参阅：[VSCode 调试文档](https://code.visualstudio.com/docs/editor/debugging)

```json
// title: .vscode/launch.json
{
  "version": "0.2.0",
  "configurations": [
    {
      "type": "node",
      "request": "launch", // 启动模式
      "name": "Dev server", // 配置名称
      "program": "${workspaceFolder}/ace.js", // 要执行的程序
      "args": ["serve", "--hmr"], // 传递给程序的参数
      "skipFiles": ["<node_internals>/**"] // 忽略内部 Node.js 文件
    }
  ]
}
```

要开始调试：

1.  打开**命令面板** (`CMD + Shift + P`)。
2.  搜索 **Debug: Select and Start Debugging**（调试：选择并开始调试）。您将看到 `.vscode/launch.json` 文件中的启动选项列表。
3.  选择 **Dev server** 选项以使用 VSCode 调试器运行 HTTP 服务器。

### 调试测试 (Debugging tests)

您可以定义另一个启动选项，以在调试模式下运行测试。

```json
// title: .vscode/launch.json
{
  "version": "0.2.0",
  "configurations": [
    {
      "type": "node",
      "request": "launch",
      "name": "Dev server",
      "program": "${workspaceFolder}/ace.js",
      "args": ["serve", "--hmr"],
      "skipFiles": ["<node_internals>/**"]
    },
    {
      "type": "node",
      "request": "launch",
      "name": "Tests", // 新增的测试调试配置
      "program": "${workspaceFolder}/ace.js",
      "args": ["test", "--watch"], // 运行 ace test --watch
      "skipFiles": ["<node_internals>/**"]
    }
  ]
}
```

### 调试所有其他 Ace 命令 (Debugging all other Ace commands)

为每个 `ace` 命令定义单独的启动选项是不切实际的。因此，您可以在 **`.vscode/launch.json` 文件**中定义一个 **`attach`（附加）配置**。

在 `attach` 模式下，如果 Node.js 进程是从 VSCode **集成终端**中使用 **`--inspect` 标志**启动的，VSCode 将**附加**其调试器到该正在运行的 Node.js 进程。

我们首先修改 `.vscode/launch.json` 文件，并向其中添加以下配置：

```json
// title: .vscode/launch.json
{
  "version": "0.2.0",
  "configurations": [
    {
      "type": "node",
      "request": "attach", // 附加模式
      "name": "Attach Program",
      "port": 9229, // Node.js 调试器默认端口
      "autoAttachChildProcesses": true,
      "skipFiles": ["<node_internals>/**"]
    },
    // ... Dev server 配置
    // ... Tests 配置
  ]
}
```

要以附加模式开始调试：

1.  打开**命令面板** (`CMD + Shift + P`)。
2.  搜索 **Debug: Select and Start Debugging**。
3.  选择 **Attach Program** 选项。
4.  使用 **`--inspect` 标志**运行一个 Ace 命令。例如：
    ```sh
    node --inspect ace migration:run
    ```

::video{url="[https://res.cloudinary.com/adonis-js/video/upload/v1726932262/n91xtzqavpdoro79lnza.mp4](https://res.cloudinary.com/adonis-js/video/upload/v1726932262/n91xtzqavpdoro79lnza.mp4)" controls="true"}

### 调试 Edge 模板 (Debugging Edge templates)

您可以像调试 TypeScript 应用程序代码一样调试 **Edge 模板**。但是，对于 Edge，您不能使用 VSCode 提供的断点。相反，您必须使用 **`@debugger` 标签**来定义一个**代码内断点**。

:::note

调试器将显示 Edge 模板的**编译输出**。

:::

```edge
@debugger
```

-----

## Dump and Die (dd)

**Dump and Die**（通常称为 **`dd`**）类似于最受欢迎的调试技术 `console.log`。但是，`dd` 辅助函数将通过**抛出异常**并**在浏览器或终端中显示输出**来**终止执行**。

当您在 HTTP 请求期间使用 `dd` 辅助函数时，输出将渲染为 **HTML 文档**。否则，输出将显示在**终端**中。

```ts
// title: start/routes.ts
import User from '#models/user'
import router from '@adonisjs/core/services/router'
import { dd } from '@adonisjs/core/services/dumper' // 导入 dd 辅助函数

router.get('/users', async () => {
  const users = await User.all()
  /**
   * 访问 "/users" 端点以查看转储的值
   */
  dd(users) // 转储 users 变量的值并停止执行
  return users
})
```

`dd` 的输出与您使用 `console.log` 时看到的略有不同：

  * 您可以看到**值被转储的源代码位置**。
  * 您可以查看类的**静态属性**和对象的**原型属性**。
  * 默认情况下，显示**最多 10 级深**的嵌套值。
  * 支持 HTML 输出的多种主题，例如 `nightOwl`、`catppuccin` 和 `minLight`。

[Image of browser-dd.png]

### Edge 模板的调试辅助函数 (Edge helpers for debugging)

您可以通过 **`@dd` 标签**在 Edge 模板中使用 `dd` 辅助函数。此外，您可以使用 **`@dump` 辅助函数**，它**不会抛出异常**并继续渲染模板的其余部分。

```edge
{{-- 转储模板状态并终止 --}}
@dd(state)

{{-- 转储模板状态并继续渲染 --}}
@dump(state)
```

使用 `@dump` 辅助函数时，请确保页面上有一个名为 `"dumper"` 的 [EdgeJS Stack](https://edgejs.dev/docs/stacks)。`@dump` 辅助函数使用的脚本和样式将写入此堆栈，以便包含在最终的 HTML 输出中。

```edge
<!DOCTYPE html>
  <html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    @stack('dumper') {{-- 必须包含 dumper 堆栈 --}}
  </head>
  <body>
    @dump(state)
  </body>
</html>
```

### Dumper 设置 (Dumper settings)

您可以在 **`config/app.ts` 文件**中配置 dumper 设置。此文件应导出一个 `dumper` 配置对象，如下所示：

```ts
// title: config/app.ts
/**
 * "dd" 辅助函数使用的全局配置。您可以分别
 * 配置 "console" 和 "html" 打印机的设置。
 */
export const dumper = dumperConfig({
  /**
   * 控制台打印机的设置
   */
  console: {
    depth: 10,
    /**
     * 不应进一步展开的对象。数组接受对象构造函数名称的数组。
     */
    collapse: ['DateTime', 'Date'],
    inspectStaticMembers: true,
  },

  /**
   * HTML 打印机的设置
   */
  html: {
    depth: 10,
    inspectStaticMembers: true,
  },
})
```

\<dl\>

\<dt\> `showHidden` \</dt\>
\<dd\>

设置为 `true` 时，将处理对象的**不可枚举属性**。**默认值：`false`**

\</dd\>

\<dt\> `depth` \</dt\>
\<dd\>

停止解析嵌套值的深度。该深度在所有树状数据结构（例如，对象、数组、Map 和 Set）之间共享。**默认值：`5`**

\</dd\>

\<dt\> `inspectObjectPrototype` \</dt\>
\<dd\>

检查对象的**原型属性**。原型中不可枚举的属性默认包含在内。**默认值：`'unless-plain-object'`**。

  * 设置为 `true` 时，将处理所有对象的原型属性。
  * 设置为 `false` 时，永远不会处理原型属性。
  * 设置为 `'unless-plain-object'` 时，将处理**类实例**的原型属性。

\</dd\>

\<dt\> `inspectArrayPrototype` \</dt\>
\<dd\>

检查数组的原型属性。**默认值：`false`**。

\</dd\>

\<dt\> `inspectStaticMembers` \</dt\>
\<dd\>

检查类的**静态成员**。**默认值：`false`**。

\</dd\>

\<dt\> `maxArrayLength` \</dt\>
\<dd\>

要处理的 `Arrays`、`Maps` 和 `Sets` 的**最大成员数量**。**默认值：`100`**。

\</dd\>

\<dt\> `maxStringLength` \</dt\>
\<dd\>

要显示的字符串的**最大字符数**。**默认值：`1000`**。

\</dd\>

\<dt\> `collapse` \</dt\>
\<dd\>

不应进一步检查的**对象构造函数名称**的数组。

\</dd\>

\</dl\>

-----

## 框架调试日志 (Framework debug logs)

您可以使用 **`NODE_DEBUG` 环境变量**查看框架调试日志。Node.js 运行时支持 `NODE_DEBUG` 标志，您可以使用它来查看一个或多个模块（使用模块名称）的日志。

例如，您可以使用 **`NODE_DEBUG="adonisjs:*"`** 值查看**所有 AdonisJS 包**的日志。

```sh
NODE_DEBUG="adonisjs:*" node ace serve --hmr
```

类似地，您可以使用 `NODE_DEBUG` 环境变量查看来自 Node.js 本地模块（如 `fs`、`net`、`module` 等）的日志。

```sh
NODE_DEBUG="adonisjs:*,net,fs" node ace serve --hmr
```