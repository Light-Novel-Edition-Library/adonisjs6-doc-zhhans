# 容器服务 (Container services)

正如我们在 [IoC 容器指南](https://www.google.com/search?q=./dependency_injection.md%23container-bindings)中讨论的那样，容器绑定是 AdonisJS 中存在 IoC 容器的主要原因之一。

容器绑定使您的代码库免受在使用对象前构建对象所需的样板代码的影响。

在下面的示例中，在您可以使用 `Database` 类之前，您必须创建一个它的实例。根据您正在构建的类，您可能需要编写大量样板代码来获取它的所有依赖项。

```ts
import { Database } from '@adonisjs/lucid'
export const db = new Database(
  // 注入配置和其他依赖项
)
```

但是，当使用 IoC 容器时，您可以将构建类的任务卸载给容器，并获取一个预构建的实例。

```ts
import app from '@adonisjs/core/services/app'
const db = await app.container.make('lucid.db')
```

## 容器服务的必要性 (The need for container services)

使用容器来解析预配置的对象非常棒。然而，使用 `container.make` 方法也有其自身的缺点。

  * 编辑器擅长自动导入。如果您尝试使用一个变量，并且编辑器可以猜测该变量的导入路径，那么它会为您编写导入语句。**但是，这对于 `container.make` 调用不起作用。**
  * 与拥有统一的导入/使用模块语法相比，混合使用导入语句和 `container.make` 调用感觉不直观。

为了克服这些缺点，我们将 `container.make` 调用包装在常规 JavaScript 模块中，这样您就可以使用 `import` 语句获取它们。

例如，`@adonisjs/lucid` 包有一个名为 `services/db.ts` 的文件，该文件的内容大致如下：

```ts
const db = await app.container.make('lucid.db')
export { db as default }
```

在您的应用程序中，您可以将 `container.make` 调用替换为指向 `services/db.ts` 文件的导入。

```ts
// delete-start
import app from '@adonisjs/core/services/app'
const db = await app.container.make('lucid.db')
// delete-end
// insert-start
import db from '@adonisjs/lucid/services/db'
// insert-end
```

如您所见，我们仍然依赖容器来为我们解析 Database 类的实例。但是，通过一层间接层，我们可以用常规的 `import` 语句替换 `container.make` 调用。

**包装 `container.make` 调用的 JavaScript 模块被称为容器服务 (Container service)。** 几乎每个与容器交互的包都附带一个或多个容器服务。

## 容器服务 vs. 依赖注入 (Container services vs. Dependency injection)

容器服务是依赖注入的一种替代方案。例如，您可以请求 `drive` 服务给您一个磁盘实例，而不是接受 `Disk` 类作为依赖项。让我们看一些代码示例。

在下面的示例中，我们使用 `@inject` 装饰器来注入 `Disk` 类的一个实例。

```ts
import { Disk } from '@adonisjs/drive'
import { inject } from '@adonisjs/core'

  // highlight-start
@inject()
export class PostService {
  constructor(protected disk: Disk) {
  }
  // highlight-end  

  async save(post: Post, coverImage: File) {
    const coverImageName = 'random_name.jpg'

    // highlight-start
    await this.disk.put(coverImageName, coverImage)
    // highlight-end
    
    post.coverImage = coverImageName
    await post.save()
  }
}
```

当使用 `drive` 服务时，我们调用 `drive.use` 方法来获取使用 `s3` 驱动程序的 `Disk` 实例。

```ts
import drive from '@adonisjs/drive/services/main'

export class PostService {
  async save(post: Post, coverImage: File) {
    const coverImageName = 'random_name.jpg'

    // highlight-start
    const disk = drive.use('s3')
    await disk.put(coverImageName, coverImage)
    // highlight-end
    
    post.coverImage = coverImageName
    await post.save()
  }
}
```

容器服务非常适合保持代码简洁。而依赖注入则在不同的应用程序部分之间建立了松散耦合。

选择哪一种取决于您的个人喜好以及您希望构建代码的方法。

## 使用容器服务进行测试 (Testing with container services)

依赖注入最明显的直接好处是能够在编写测试时交换依赖项。

为了在使用容器服务时提供类似的测试体验，AdonisJS 提供了用于在编写测试时伪造实现的一流 API。

在下面的示例中，我们调用 `drive.fake` 方法将驱动磁盘交换为内存驱动程序。创建伪造对象后，对 `drive.use` 方法的任何调用都将接收伪造的实现。

```ts
import drive from '@adonisjs/drive/services/main'
import { PostService } from '#services/post_service'

test('save post', async ({ assert }) => {
  /**
   * 伪造 s3 磁盘
   */
  drive.fake('s3')
 
  const postService = new PostService()
  await postService.save(post, coverImage)
  
  /**
   * 编写断言
   */
  assert.isTrue(await drive.use('s3').exists(coverImage.name))
  
  /**
   * 恢复伪造
   */
  drive.restore('s3')
})
```

## 容器绑定和服务 (Container bindings and services)

下表列出了框架核心和第一方包导出的容器绑定及其相关服务列表。

| Binding (绑定) | Class (类) | Service (服务) |
| :--- | :--- | :--- |
| `app` | [Application](https://github.com/adonisjs/application/blob/main/src/application.ts) | `@adonisjs/core/services/app` |
| `ace` | [Kernel](https://github.com/adonisjs/core/blob/main/modules/ace/kernel.ts) | `@adonisjs/core/services/kernel` |
| `config` | [Config](https://github.com/adonisjs/config/blob/main/src/config.ts) | `@adonisjs/core/services/config` |
| `encryption` | [Encryption](https://github.com/adonisjs/encryption/blob/main/src/encryption.ts) | `@adonisjs/core/services/encryption` |
| `emitter` | [Emitter](https://github.com/adonisjs/events/blob/main/src/emitter.ts) | `@adonisjs/core/services/emitter` |
| `hash` | [HashManager](https://github.com/adonisjs/hash/blob/main/src/hash_manager.ts) | `@adonisjs/core/services/hash` |
| `logger` | [LoggerManager](https://github.com/adonisjs/logger/blob/main/src/logger_manager.ts) | `@adonisjs/core/services/logger` |
| `repl` | [Repl](https://github.com/adonisjs/repl/blob/main/src/repl.ts) | `@adonisjs/core/services/repl` |
| `router` | [Router](https://github.com/adonisjs/http-server/blob/main/src/router/main.ts) | `@adonisjs/core/services/router` |
| `server` | [Server](https://github.com/adonisjs/http-server/blob/main/src/server/main.ts) | `@adonisjs/core/services/server` |
| `testUtils` | [TestUtils](https://github.com/adonisjs/core/blob/main/src/test_utils/main.ts) | `@adonisjs/core/services/test_utils` |