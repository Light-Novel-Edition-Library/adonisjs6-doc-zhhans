# Lucid ORM

**Lucid** 是一个 SQL **查询构建器**和一个 **Active Record ORM**，它构建在 [Knex](https://knexjs.org) 之上，由 AdonisJS 核心团队创建和维护。Lucid 致力于充分发挥 SQL 的潜力，并为许多高级 SQL 操作提供简洁的 API。

:::note
Lucid 的文档可在 [https://lucid.adonisjs.com](https://lucid.adonisjs.com) 上查阅。
:::

-----

## 为什么选择 Lucid (Why Lucid)

以下是 Lucid 的一些精选特性：

  * 建立在 **Knex** 之上的**流畅查询构建器**。
  * 支持**读写分离**和**多连接管理**。
  * 遵循 **Active Record 模式**的**基于类的模型**（处理**关系**、**序列化**和**钩子**）。
  * **迁移系统**，用于使用增量变更集修改数据库 schema。
  * **模型工厂**，用于为测试生成虚假数据。
  * **数据库 Seeder**，用于向数据库插入初始/虚拟数据。

除了这些之外，在 AdonisJS 应用程序中使用 Lucid 还有以下额外原因：

  * 我们为 Lucid 提供了与 **Auth 包**和**验证器**的**一流集成**。因此，您无需自己编写这些集成。
  * Lucid 随 **`api`** 和 **`web`** 入门套件预先配置，为您的应用程序提供了先发优势。
  * Lucid 的主要目标之一是充分发挥 SQL 的潜力，并支持许多**高级 SQL 操作**，如**窗口函数**、**递归 CTE**、**JSON 操作**、**基于行的锁**等。
  * Lucid 和 Knex 都已经存在多年。因此，与许多其他新 ORM 相比，它们**更成熟且经过实战检验**。

话虽如此，AdonisJS **不会强制**您使用 Lucid。只需卸载该包并安装您选择的 ORM 即可。

-----

## 安装 (Installation)

使用以下命令安装和配置 Lucid。

```sh
node ace add @adonisjs/lucid
```

:::disclosure{title="查看配置命令执行的步骤"}

1.  在 `adonisrc.ts` 文件中注册以下**服务提供程序**。

    ```ts
    {
      providers: [
        // ...其他提供程序
        () => import('@adonisjs/lucid/database_provider'),
      ]
    }
    ```

2.  在 `adonisrc.ts` 文件中注册以下**命令**。

    ```ts
    {
      commands: [
        // ...其他命令
        () => import('@adonisjs/lucid/commands'),
      ]
    }
    ```

3.  创建 **`config/database.ts` 文件**。

4.  为所选的数据库方言定义**环境变量及其验证**。

5.  安装所需的**对等依赖**。

:::

-----

## 创建您的第一个模型 (Creating your first model)

配置完成后，您可以使用以下命令创建您的第一个模型。

```sh
node ace make:model User
```

此命令会在 **`app/models` 目录**中创建一个新文件，内容如下。

```ts
import { DateTime } from 'luxon'
import { BaseModel, column } from '@adonisjs/lucid/orm'

export default class User extends BaseModel {
  @column({ isPrimary: true })
  declare id: number

  @column.dateTime({ autoCreate: true })
  declare createdAt: DateTime

  @column.dateTime({ autoCreate: true, autoUpdate: true })
  declare updatedAt: DateTime
}
```

通过访问[官方文档](https://lucid.adonisjs.com/docs/models)了解更多关于模型的信息。

-----

## 迁移 (Migrations)

**迁移**是一种使用**增量变更集**修改数据库 schema 和数据的方式。您可以使用以下命令创建新的迁移。

```sh
node ace make:migration users
```

此命令会在 **`database/migrations` 目录**中创建一个新文件，内容如下。

```ts
import { BaseSchema } from '@adonisjs/lucid/schema'

export default class extends BaseSchema {
  // 定义表名
  protected tableName = 'users' 

  // 运行迁移时执行的操作 (创建表)
  async up() { 
    this.schema.createTable(this.tableName, (table) => {
      table.increments('id')
      table.timestamp('created_at')
      table.timestamp('updated_at')
    })
  }

  // 撤销迁移时执行的操作 (删除表)
  async down() { 
    this.schema.dropTable(this.tableName)
  }
}
```

您可以使用以下命令运行所有待处理的迁移。

```sh
node ace migration:run
```

通过访问[官方文档](https://lucid.adonisjs.com/docs/migrations)了解更多关于迁移的信息。

-----

## 查询构建器 (Query Builder)

Lucid 附带一个建立在 **Knex** 之上的**流畅查询构建器**。您可以使用查询构建器对数据库执行 CRUD 操作。

```ts
import db from '@adonisjs/lucid/services/db'

/**
 * 创建查询构建器实例
 */
const query = db.query()

/**
 * 创建查询构建器实例并选择表
 */
const queryWithTableSelection = db.from('users')
```

查询构建器也可以限定于**模型实例**。

```ts
import User from '#models/user'

// 使用 User 模型查询
const user = await User.query().where('username', 'rlanz').first() 
```

通过访问[官方文档](https://lucid.adonisjs.com/docs/select-query-builder)了解更多关于查询构建器的信息。

-----

## CRUD 操作 (CRUD operations)

Lucid 模型具有内置的方法，可用于在数据库上执行 **CRUD**（创建、读取、更新、删除）操作。

```ts
import User from '#models/user'

/**
 * C - Create (创建新用户)
 */
const user = await User.create({
  username: 'rlanz',
  email: 'romain@adonisjs.com',
})

/**
 * R - Read (通过主键查找用户)
 */
const user = await User.find(1)

/**
 * U - Update (更新用户)
 */
const userToUpdate = await User.find(1)
userToUpdate.username = 'romain'
await userToUpdate.save() // 保存更改

/**
 * D - Delete (删除用户)
 */
const userToDelete = await User.find(1)
await userToDelete.delete()
```

通过访问[官方文档](https://lucid.adonisjs.com/docs/crud-operations)了解更多关于 CRUD 操作的信息。

-----

## 了解更多 (Learn more)

  * [Lucid 文档](https://lucid.adonisjs.com)
  * [安装和使用](https://lucid.adonisjs.com/docs/installation)
  * [CRUD 操作](https://lucid.adonisjs.com/docs/crud-operations)
  * [模型钩子](https://lucid.adonisjs.com/docs/model-hooks)
  * [关系](https://lucid.adonisjs.com/docs/relationships)
  * [Adocasts Lucid 系列播客](https://adocasts.com/topics/lucid)