# TypeScript 构建流程 (TypeScript build process)

用 TypeScript 编写的应用程序在投入生产运行之前，必须先**编译成 JavaScript**。

编译 TypeScript 源文件可以使用许多不同的构建工具来完成。然而，对于 AdonisJS，我们坚持采用最直接的方法，并使用以下经过时间考验的工具。

:::note

以下提到的所有工具都作为开发依赖项预安装在官方起始套件中。

:::

  * **[TSC](https://www.typescriptlang.org/docs/handbook/compiler-options.html)** 是 TypeScript 的官方编译器。我们使用 **TSC** 来执行**类型检查**并创建**生产构建**。
  * **[TS Node Maintained](https://github.com/thetutlage/ts-node-maintained)** 是 TypeScript 的**即时编译器 (Just-in-Time compiler)**。它允许您无需将 TypeScript 文件编译为 JavaScript 即可执行它们，并被证明是开发中的绝佳工具。
  * **[SWC](https://swc.rs/)** 是一个用 Rust 编写的 TypeScript 编译器。我们在开发过程中将其与 TS Node 配合使用，以使 JIT 过程**极其快速**。

| 工具 | 用途 | 类型检查 |
| :--- | :--- | :--- |
| `TSC` | 创建生产构建 | 是 |
| `TS Node` | 开发 | 否 |
| `SWC` | 开发 | 否 |

-----

## 无需编译即可执行 TypeScript 文件 (Executing TypeScript files without compilation)

您可以使用 `ts-node-maintained/register/esm` 钩子来执行 TypeScript 文件而无需编译它们。例如，您可以通过运行以下命令来启动 HTTP 服务器。

```sh
node --import=ts-node-maintained/register/esm bin/server.js
```

  * `--import`：`import` 标志允许您指定一个模块，该模块导出用于模块解析和加载的自定义钩子。有关更多信息，请参阅 [Node.js 定制钩子文档](https://nodejs.org/docs/latest-v22.x/api/module.html#customization-hooks)。
  * `ts-node-maintained/register/esm`：`ts-node-maintained/register/esm` 脚本的路径，它注册了生命周期钩子以执行 TypeScript 源代码到 JavaScript 的即时编译。
  * `bin/server.js`：AdonisJS HTTP 服务器入口文件的路径。**另请参阅：[关于文件扩展名的注意事项](https://www.google.com/search?q=%23a-note-on-file-extensions)**

您也可以对其他 TypeScript 文件重复此过程。例如：

```sh
// title: 运行测试 (Run tests)
node --import=ts-node-maintained/register/esm bin/test.ts
```

```sh
// title: 运行 ace 命令 (Run ace commands)
node --import=ts-node-maintained/register/esm bin/console.ts
```

```sh
// title: 运行一些其他 TypeScript 文件 (Run some other TypeScript file)
node --import=ts-node-maintained/register/esm path/to/file.ts
```

### 关于文件扩展名的注意事项 (A note on file extensions)

您可能已经注意到我们在任何地方都使用了 **`.js` 文件扩展名**，即使磁盘上的文件是以 **`.ts`** 扩展名保存的。

这是因为，对于 **ES 模块**，TypeScript 强制您在导入和运行脚本时使用 `.js` 扩展名。您可以在 [TypeScript 文档](https://www.typescriptlang.org/docs/handbook/modules/theory.html#typescript-imitates-the-hosts-module-resolution-but-with-types) 中了解做出此选择背后的理论。

:::tip

如果您使用的是 TypeScript 5.7 或更高版本，您可以使用 **`.ts` 扩展名**导入 TypeScript 文件。这得益于 [相对路径的路径重写](https://devblogs.microsoft.com/typescript/announcing-typescript-5-7-beta/#path-rewriting-for-relative-paths) 功能。

由于某些运行时允许您“就地”运行 TypeScript 代码并要求使用 `.ts` 扩展名，因此您可能更喜欢使用 `.ts` 扩展名以实现未来的兼容性。

:::

-----

## 运行开发服务器 (Running the development server)

我们建议使用 `serve` 命令而不是直接运行 `bin/server.js` 文件，原因如下：

  * 该命令包含一个**文件监视器**，并在文件更改时重启开发服务器。
  * `serve` 命令会检测您的应用程序使用的**前端资产打包工具**并启动其开发服务器。例如，如果您的项目根目录中有 `vite.config.js` 文件，`serve` 命令将启动 `vite` 开发服务器。

<!-- end list -->

```sh
node ace serve --watch
```

您可以使用 `--assets-args` 命令行标志将参数传递给 Vite 开发服务器。

```sh
node ace serve --watch --assets-args="--debug --base=/public"
```

您可以使用 `--no-assets` 标志来禁用 Vite 开发服务器。

```sh
node ace serve --watch --no-assets
```

### 将选项传递给 Node.js 命令行 (Passing options to the Node.js commandline)

`serve` 命令将开发服务器 (`bin/server.ts` 文件) 作为**子进程**启动。如果您想将 [node 参数](https://nodejs.org/api/cli.html#options) 传递给子进程，您可以在命令名称之前定义它们。

```sh
node ace --no-warnings --inspect serve --watch
```

-----

## 创建生产构建 (Creating production build)

您的 AdonisJS 应用程序的生产构建是使用 `node ace build` 命令创建的。`build` 命令执行以下操作以在 `./build` 目录中创建一个**独立 JavaScript 应用程序**（**Standalone JavaScript application**，参见下文）

  * 删除现有的 `./build` 文件夹（如果存在）。
  * **从头开始**重写 `ace.js` 文件以删除 `ts-node/esm` 加载器。
  * 使用 Vite 编译前端资产（如果已配置）。
  * 使用 **[`tsc`](https://www.google.com/search?q=%5Bhttps://www.typescriptlang.org/docs/handbook/compiler-options.html%5D\(https://www.typescriptlang.org/docs/handbook/compiler-options.html\))** 将 TypeScript 源代码编译为 JavaScript。
  * 将 [`metaFiles`](https://www.google.com/search?q=../concepts/adonisrc_file.md%23metafiles) 数组下注册的非 TypeScript 文件复制到 `./build` 文件夹。
  * 将 `package.json` 和 `package-lock.json/yarn.lock` 文件复制到 `./build` 文件夹。

:::warning
对 `ace.js` 文件的任何修改都将在构建过程中丢失，因为该文件是从头开始重写的。如果您想在 Ace 启动之前运行任何附加代码，则应将其放在 `bin/console.ts` 文件中。
:::

就是这样！

```sh
node ace build
```

一旦创建了构建，您可以 `cd` 进入 `build` 文件夹，安装生产依赖项，然后运行您的应用程序。

```sh
cd build

# 安装生产依赖项
npm ci --omit=dev

# 运行服务器
node bin/server.js
```

您可以使用 `--assets-args` 命令行标志将参数传递给 Vite 构建命令。

```sh
node ace build --assets-args="--debug --base=/public"
```

您可以使用 `--no-assets` 标志来避免编译前端资产。

```sh
node ace build --no-assets
```

### 什么是独立构建？ (What is a standalone build?)

**独立构建**指的是您的应用程序的 JavaScript 输出，您可以在没有原始 TypeScript 源代码的情况下运行它。

创建独立构建有助于减少您部署到生产服务器的代码大小，因为您不必同时复制源文件和 JavaScript 输出。

创建生产构建后，您可以将 `./build` 复制到您的生产服务器，安装依赖项，定义环境变量，然后运行应用程序。