# 服务提供者 (Service providers)

服务提供者是**普通 JavaScript 类**，具有生命周期方法，用于在应用程序的不同阶段执行操作。

服务提供者可以[向容器中注册绑定](https://www.google.com/search?q=../concepts/dependency_injection.md%23container-bindings)、[扩展现有绑定](https://www.google.com/search?q=../concepts/dependency_injection.md%23container-events)，或在 HTTP 服务器启动后运行操作。

服务提供者是 AdonisJS 应用程序的入口点，它能够在应用程序被视为**就绪 (ready)** 之前修改应用程序状态。**它主要被外部包用于挂钩 (hook into) 应用程序的生命周期。**

:::note
如果您的目的只是向您的某个类注入依赖项，可以使用[依赖注入](https://www.google.com/search?q=../concepts/dependency_injection.md)功能。
:::

服务提供者在 `adonisrc.ts` 文件中的 `providers` 数组中注册。该值是一个用于**延迟导入**服务提供者的函数。

```ts
{
  providers: [
    () => import('@adonisjs/core/providers/app_provider'),
    () => import('./providers/app_provider.js'),
  ]
}
```

默认情况下，提供者在所有运行时环境中加载。但是，您可以限制提供者在特定的环境中运行。

```ts
{
  providers: [
    () => import('@adonisjs/core/providers/app_provider'),
    {
      file: () => import('./providers/app_provider.js'),
      environment: ['web', 'repl']
    }
  ]
}
```

-----

## 编写服务提供者 (Writing service providers)

服务提供者存储在应用程序的 `providers` 目录中。或者，您可以使用 `node ace make:provider app` 命令。

提供者模块必须有一个 `export default` 语句，返回提供者类。类的构造函数接收 [Application](https://www.google.com/search?q=./application.md) 类的一个实例。

另请参阅：[Make provider 命令](https://www.google.com/search?q=../references/commands.md%23makeprovider)

```ts
import { ApplicationService } from '@adonisjs/core/types'

export default class AppProvider {
  // 构造函数接收 ApplicationService 实例
  constructor(protected app: ApplicationService) {
  }
}
```

以下是您可以实现以执行不同操作的生命周期方法。

```ts
export default class AppProvider {
  register() {
  }
  
  async boot() {
  }
  
  async start() {
  }
  
  async ready() {
  }
  
  async shutdown() {
  }
}
```

### register

`register` 方法在提供者类的一个实例创建后被调用。`register` 方法可以在 **IoC 容器**内注册绑定。

`register` 方法是**同步的**，因此您不能在该方法内使用 Promise。

```ts
export default class AppProvider {
  register() {
    this.app.container.bind('db', () => {
      return new Database()
    })
  }
}
```

### boot

`boot` 方法在**所有绑定**都已注册到 IoC 容器后被调用。在该方法内部，您可以从容器中解析绑定以**扩展/修改**它们。

```ts
export default class AppProvider {
  async boot() {
   const validator = await this.app.container.make('validator')
    
   // 添加自定义验证规则
   validator.rule('foo', () => {})
  }
}
```

当绑定从容器中解析时扩展它们是一个很好的实践。例如，您可以使用 `resolving` 钩子向验证器添加自定义规则。

```ts
async boot() {
  // 当 'validator' 绑定被解析时执行回调
  this.app.container.resolving('validator', (validator) => {
    validator.rule('foo', () => {})
  })
}
```

### start

`start` 方法在 `boot` 之后、`ready` 方法之前被调用。它允许您执行 `ready` 钩子操作可能需要的操作。

### ready

`ready` 方法根据应用程序的环境在不同的阶段被调用。

| 环境 | 描述 |
| :--- | :--- |
| `web` | `ready` 方法在 HTTP 服务器**已启动并准备好接受请求**后被调用。 |
| `console` | `ready` 方法在主命令的 `run` 方法**之前**被调用。 |
| `test` | `ready` 方法在运行所有测试**之前**被调用。然而，测试文件是在 `ready` 方法之前导入的。 |
| `repl` | `ready` 方法在终端上显示 REPL 提示符**之前**被调用。 |

```ts
export default class AppProvider {
  async start() {
    if (this.app.getEnvironment() === 'web') {
      // 仅在 web 环境中执行的操作
    }

    if (this.app.getEnvironment() === 'console') {
      // 仅在 console 环境中执行的操作
    }

    if (this.app.getEnvironment() === 'test') {
      // 仅在 test 环境中执行的操作
    }

    if (this.app.getEnvironment() === 'repl') {
      // 仅在 repl 环境中执行的操作
    }
  }
}
```

### shutdown

`shutdown` 方法在 AdonisJS **优雅地退出应用程序**的过程中被调用。

应用程序退出的事件取决于应用程序运行的环境以及应用程序进程的启动方式。请阅读 [应用程序生命周期指南](https://www.google.com/search?q=./application_lifecycle.md) 以了解更多信息。

```ts
export default class AppProvider {
  async shutdown() {
    // 执行清理操作
  }
}
```