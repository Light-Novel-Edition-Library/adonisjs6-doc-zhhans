# 静态文件服务器 (Static files server)

您可以使用 **`@adonisjs/static` 包**从给定目录提供静态文件。该包附带一个**中间件**，您必须将其注册到 [**服务器中间件堆栈**](https://www.google.com/search?q=./middleware.md%23server-middleware-stack) 中，以拦截 HTTP 请求并提供文件。

-----

## 安装 (Installation)

该包已预配置在 **`web` 入门套件**中。但是，您可以像使用其他入门套件一样，按以下方式安装和配置它。

使用以下命令安装和配置包：

```sh
node ace add @adonisjs/static
```

:::disclosure{title="查看 add 命令执行的步骤"}

1.  使用检测到的包管理器安装 `@adonisjs/static` 包。
2.  在 `adonisrc.ts` 文件中注册以下服务提供程序。
    ```ts
    {
      providers: [
        // ...other providers
        () => import('@adonisjs/static/static_provider')
      ]
    }
    ```
3.  创建 `config/static.ts` 文件。
4.  在 `start/kernel.ts` 文件中注册以下中间件。
    ```ts
    server.use([
      // 注册静态文件中间件
      () => import('@adonisjs/static/static_middleware') 
    ])
    ```

:::

-----

## 配置 (Configuration)

静态中间件的配置存储在 **`config/static.ts` 文件**中。

```ts
import { defineConfig } from '@adonisjs/static'

const staticServerConfig = defineConfig({
  enabled: true, // 是否启用
  etag: true, // 启用 ETag
  lastModified: true, // 启用 Last-Modified 标头
  dotFiles: 'ignore', // 如何处理点文件
})

export default staticServerConfig
```

\<dl\>

\<dt\> `enabled` \</dt\>

\<dd\>

启用或禁用中间件，而无需将其从中间件堆栈中删除。

\</dd\>

\<dt\> `acceptRanges` \</dt\>

\<dd\>

`Accept-Range` 标头允许浏览器**恢复**中断的文件下载，而不是尝试重新开始下载。您可以通过将 `acceptsRanges` 设置为 `false` 来禁用可恢复下载。

默认值：`true`。

\</dd\>

\<dt\> `cacheControl` \</dt\>

\<dd\>

启用或禁用 [**`Cache-Control`**](https://www.google.com/search?q=%5Bhttps://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Cache-Control%5D\(https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Cache-Control\)) 标头。当 `cacheControl` 禁用时，`immutable` 和 `maxAge` 属性将被忽略。

```ts
{
  cacheControl: true
}
```

\</dd\>

\<dt\> `dotFiles` \</dt\>

\<dd\>

定义如何处理对 `public` 目录中**点文件**（以 `.` 开头的文件，如 `.env`）的请求。您可以设置以下选项之一：

  * `allow`：像处理其他文件一样提供点文件。
  * `deny`：使用 `403` 状态码拒绝请求。
  * `ignore`：假装文件不存在，并响应 `404` 状态码。

<!-- end list -->

```ts
{
  dotFiles: 'ignore'
}
```

\</dd\>

\<dt\> `etag` \</dt\>

\<dd\>

启用或禁用 [**`etag`**](https://www.google.com/search?q=%5Bhttps://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/ETag%5D\(https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/ETag\))（实体标签）生成。

```ts
{
  etag: true,
}
```

\</dd\>

\<dt\> `lastModified` \</dt\>

\<dd\>

启用或禁用 [**`Last-Modified`**](https://www.google.com/search?q=%5Bhttps://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Last-Modified%5D\(https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Last-Modified\)) 标头。文件 [stat.mtime](https://nodejs.org/api/fs.html#statsmtime) 属性用作该标头的值。

```ts
{
  lastModified: true,
}
```

\</dd\>

\<dt\> `immutable` \</dt\>

\<dd\>

启用或禁用 `Cache-Control` 标头的 [**`immutable`**](https://www.google.com/search?q=%5Bhttps://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Cache-Control%23immutable%5D\(https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Cache-Control%23immutable\)) 指令。默认情况下，`immutable` 属性是禁用的。

如果启用了 `immutable` 属性，则必须定义 `maxAge` 属性以启用缓存。

```ts
{
  immutable: true
}
```

\</dd\>

\<dt\> `maxAge` \</dt\>

\<dd\>

定义 `Cache-Control` 标头的 [**`max-age`**](https://www.google.com/search?q=%5Bhttps://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Cache-Control%23max-age%5D\(https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Cache-Control%23max-age\)) 指令。该值应以**毫秒**为单位或为**时间表达式字符串**（如 `'30 mins'`）。

```ts
{
  maxAge: '30 mins'
}
```

\</dd\>

\<dt\> `headers` \</dt\>

\<dd\>

一个返回要在响应上设置的**标头对象**的函数。该函数接收**文件路径**作为第一个参数，[**文件统计**](https://nodejs.org/api/fs.html#class-fsstats) 对象作为第二个参数。您可以使用此来自定义标头，例如 `Content-Type`。

```ts
{
  headers: (path, stats) => {
    if (path.endsWith('.mc2')) {
      return {
        // 自定义 Content-Type
        'content-type': 'application/octet-stream' 
      }
    }
  }
}
```

\</dd\>

\</dl\>

-----

## 提供静态文件 (Serving static files)

一旦注册了中间件，您就可以在 **`public` 目录**中创建文件，并使用文件路径在浏览器中访问它们。例如，可以通过 **`http://localhost:3333/css/style.css`** URL 访问 `./public/css/style.css` 文件。

`public` 目录中的文件**不会**使用资产捆绑器进行编译或构建。如果您想编译前端资产，则必须将它们放在 **`resources` 目录**中并使用 [资产捆绑器](https://www.google.com/search?q=../basics/vite.md)（如 Vite）。

-----

## 将静态文件复制到生产构建 (Copying static files to production build)

当您运行 **`node ace build` 命令**时，存储在 **`/public` 目录**中的静态文件会自动复制到 **`build` 文件夹**。

复制公共文件的规则定义在 **`adonisrc.ts` 文件**中。

```ts
{
  metaFiles: [
    {
      // 匹配 public 目录下的所有文件
      pattern: 'public/**', 
      reloadServer: false
    }
  ]
}
}
```