# 部署 (Deployment)

部署 AdonisJS 应用程序与部署标准的 Node.js 应用程序没有区别。您需要一个运行 **`Node.js >= 20.6`** 的服务器以及用于安装生产依赖项的 `npm`。

本指南将涵盖在生产环境中部署和运行 AdonisJS 应用程序的通用指南。

-----

## 创建生产构建 (Creating production build)

第一步，您必须通过运行 `build` 命令来创建 AdonisJS 应用程序的**生产构建**。

另请参阅：[TypeScript 构建过程](https://www.google.com/search?q=../concepts/typescript_build_process.md)

```sh
node ace build
```

编译后的输出将写入 `./build` 目录内。如果您使用 Vite，其输出将写入 `./build/public` 目录内。

创建生产构建后，您可以将 `./build` 文件夹复制到生产服务器。**从现在起，`build` 文件夹将成为您应用程序的根目录**。

### 创建 Docker 镜像 (Creating a Docker image)

如果您使用 Docker 部署应用程序，可以使用以下 `Dockerfile` 创建 Docker 镜像。

```dockerfile
FROM node:22.16.0-alpine3.22 AS base

# 所有依赖项阶段
FROM base AS deps
WORKDIR /app
ADD package.json package-lock.json ./
RUN npm ci

# 仅生产环境依赖项阶段
FROM base AS production-deps
WORKDIR /app
ADD package.json package-lock.json ./
RUN npm ci --omit=dev

# 构建阶段
FROM base AS build
WORKDIR /app
COPY --from=deps /app/node_modules /app/node_modules
ADD . .
RUN node ace build

# 生产阶段
FROM base
ENV NODE_ENV=production
WORKDIR /app
COPY --from=production-deps /app/node_modules /app/node_modules
COPY --from=build /app/build /app
EXPOSE 8080
CMD ["node", "./bin/server.js"]
```

您可以随意修改 `Dockerfile` 以满足您的需求。

-----

## 配置反向代理 (Configuring a reverse proxy)

Node.js 应用程序通常[部署在 Nginx 等反向代理服务器后面](https://medium.com/intrinsic-blog/why-should-i-use-a-reverse-proxy-if-node-js-is-production-ready-5a079408b2ca)。因此，端口 `80` 和 `443` 上的传入流量将首先由 Nginx 处理，然后转发到您的 Node.js 应用程序。

以下是您可以作为起点使用的 Nginx 配置文件示例。

:::warning
请务必替换尖括号 `<>` 内的值。
:::

```nginx
server {
  listen 80;
  listen [::]:80;

  server_name <APP_DOMAIN.COM>;

  location / {
    proxy_pass http://localhost:<ADONIS_PORT>;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_cache_bypass $http_upgrade;
  }
}
```

-----

## 定义环境变量 (Defining environment variables)

如果您将应用程序部署在裸机服务器上（例如 DigitalOcean Droplet 或 EC2 实例），您可以使用 **`.env`** 文件来定义环境变量。请确保该文件安全存储，并且只有授权用户才能访问它。

:::note
如果您使用的是 Heroku 或 Cleavr 等部署平台，您可以使用它们的控制面板来定义环境变量。
:::

假设您已在 `/etc/secrets` 目录中创建了 `.env` 文件，则必须按如下方式启动生产服务器。

```sh
ENV_PATH=/etc/secrets node build/bin/server.js
```

`ENV_PATH` 环境变量指示 AdonisJS 在所述目录中查找 `.env` 文件。

-----

## 启动生产服务器 (Starting the production server)

您可以通过运行 `node server.js` 文件来启动生产服务器。但是，建议使用 [pm2](https://pm2.keymetrics.io/docs/usage/quick-start) 等进程管理器。

  * PM2 将在后台运行您的应用程序，而不会阻塞当前的终端会话。
  * 如果您的应用程序在处理请求时崩溃，它将重新启动应用程序。
  * 此外，PM2 使您以[集群模式](https://nodejs.org/api/cluster.html#cluster)运行应用程序变得超级简单。

以下是您可以作为起点使用的 [pm2 生态系统文件](https://pm2.keymetrics.io/docs/usage/application-declaration)示例。

```js
// title: ecosystem.config.js
module.exports = {
  apps: [
    {
      name: 'web-app',
      script: './server.js',
      instances: 'max',
      exec_mode: 'cluster',
      autorestart: true,
    },
  ],
}
```

```sh
// title: 启动服务器
pm2 start ecosystem.config.js
```

-----

## 迁移数据库 (Migrating database)

如果您使用的是 SQL 数据库，则必须在生产服务器上运行**数据库迁移 (migrations)** 以创建所需的表。

如果您使用的是 Lucid，则可以运行以下命令。

```sh
node ace migration:run --force
```

在生产环境中运行迁移时，需要使用 `--force` 标志。

### 何时运行迁移 (When to run migrations)

此外，最好始终在**重新启动服务器之前**运行迁移。然后，如果迁移失败，请不要重新启动服务器。

如果您使用 Cleavr 或 Heroku 等托管服务，它们可以自动处理此用例。否则，您必须在 CI/CD 管道内运行迁移脚本或通过 SSH 手动运行。

### 不要回滚生产环境 (Do not rollback in production)

在生产环境中回滚迁移是一项有风险的操作。迁移文件中的 `down` 方法通常包含破坏性操作，例如**删除表**或**删除列**等。

建议在 `config/database.ts` 文件中关闭生产环境的回滚功能，而是创建新的迁移来修复问题并在生产服务器上运行它。

在生产环境中禁用回滚将确保 `node ace migration:rollback` 命令导致错误。

```js
{
  pg: {
    client: 'pg',
    migrations: {
      disableRollbacksInProduction: true,
    }
  }
}
```

### 并发迁移 (Concurrent migrations)

如果您在具有多个实例的服务器上运行迁移，则必须确保**只有一个实例**运行迁移。

对于 MySQL 和 PostgreSQL，Lucid 将获取**建议锁 (advisory locks)** 以确保不允许并发迁移。但是，最好从一开始就避免从多个服务器运行迁移。

-----

## 文件上传的持久存储 (Persistent storage for file uploads)

Amazon EKS、Google Kubernetes、Heroku、DigitalOcean Apps 等环境在[**临时文件系统**](https://devcenter.heroku.com/articles/dynos#ephemeral-filesystem)中运行您的应用程序代码，这意味着每次部署默认都会清除现有文件系统并创建一个全新的文件系统。

如果您的应用程序允许用户上传文件，则必须使用 Amazon S3、Google Cloud Storage 或 DigitalOcean Spaces 等**持久存储服务**，而不是依赖本地文件系统。

-----

## 写入日志 (Writing logs)

AdonisJS 默认使用以 JSON 格式将日志写入控制台的 [`pino` logger](https://www.google.com/search?q=../digging_deeper/logger.md)。您可以设置外部日志服务从 stdout/stderr 读取日志，或将它们转发到同一服务器上的本地文件。

-----

## 提供静态资源 (Serving static assets)

有效地提供静态资源对于应用程序的性能至关重要。无论您的 AdonisJS 应用程序速度有多快，静态资源的交付对于获得更好的用户体验都起着至关重要的作用。

### 使用 CDN (Using a CDN)

最好的方法是使用 \*\*CDN（内容分发网络）\*\*来交付您的 AdonisJS 应用程序中的静态资源。

使用 [Vite](https://www.google.com/search?q=../basics/vite.md) 编译的前端资源默认是**指纹化 (fingerprinted)的，这意味着文件名是根据其内容进行哈希处理的。这允许您永久缓存**资源并从 CDN 提供它们。

根据您使用的 CDN 服务和部署技术，您可能需要在部署过程中添加一个步骤，将静态文件移动到 CDN 服务器。概括地说，它的工作原理如下：

1.  更新 `vite.config.js` 和 `config/vite.ts` 配置以[使用 CDN URL](https://www.google.com/search?q=../basics/vite.md%23deploying-assets-to-a-cdn)。
2.  运行 `build` 命令来编译应用程序和资源。
3.  将 `public/assets` 的输出复制到您的 CDN 服务器。例如，[这里有一个命令](https://github.com/adonisjs-community/polls-app/blob/main/commands/PublishAssets.ts)是我们用于将资产发布到 Amazon S3 存储桶的。

### 使用 Nginx 交付静态资源 (Using Nginx to deliver static assets)

另一种选择是将提供资源的任务**卸载给 Nginx**。如果您使用 Vite 编译前端资源，则必须积极缓存所有静态文件，因为它们是指纹化的。

将以下块添加到您的 Nginx 配置文件中。**请务必替换尖括号 `<>` 内的值**。

```nginx
location ~ \.(jpg|png|css|js|gif|ico|woff|woff2) {
  root <PATH_TO_ADONISJS_APP_PUBLIC_DIRECTORY>;
  sendfile on;
  sendfile_max_chunk 2m;
  add_header Cache-Control "public";
  expires 365d;
}
```

### 使用 AdonisJS 静态文件服务器 (Using AdonisJS static file server)

您也可以依赖 [AdonisJS 内置的静态文件服务器](https://www.google.com/search?q=../basics/static_file_server.md)来提供 `public` 目录中的静态资源，以保持简单。

无需额外的配置。只需像往常一样部署您的 AdonisJS 应用程序，对静态资源的请求将自动得到处理。

:::warning
不建议在生产环境中使用静态文件服务器。最好使用 CDN 或 Nginx 来提供静态资源。
:::