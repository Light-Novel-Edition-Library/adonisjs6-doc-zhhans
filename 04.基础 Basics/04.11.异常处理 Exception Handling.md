# 异常处理 (Exception handling)

在 HTTP 请求期间引发的异常由定义在 **`./app/exceptions/handler.ts` 文件**中的 **`HttpExceptionHandler`** 处理。在此文件中，您可以决定如何将**异常转换为响应**，并使用**日志记录器**记录它们或将它们报告给**外部日志记录提供程序**。

`HttpExceptionHandler` 扩展了 [ExceptionHandler](https://github.com/adonisjs/http-server/blob/main/src/exception_handler.ts) 类，该类完成了处理错误的所有繁重工作，并为您提供了用于调整报告和渲染行为的**高级 API**。

```ts
import app from '@adonisjs/core/services/app'
import { HttpContext, ExceptionHandler } from '@adonisjs/core/http'

export default class HttpExceptionHandler extends ExceptionHandler {
  // 生产环境中关闭调试模式
  protected debug = !app.inProduction
  // 生产环境中启用状态页渲染
  protected renderStatusPages = app.inProduction 

  async handle(error: unknown, ctx: HttpContext) {
    // 调用父类的 handle 方法
    return super.handle(error, ctx) 
  }

  async report(error: unknown, ctx: HttpContext) {
    // 调用父类的 report 方法
    return super.report(error, ctx) 
  }
}
```

-----

## 为服务器分配错误处理器 (Assigning error handler to the server)

错误处理器在 **`start/kernel.ts` 文件**中注册到 AdonisJS HTTP 服务器。我们使用 `package.json` 文件中定义的 `#exceptions` 别名**延迟导入** HTTP 处理器。

```ts
// 注册 HTTP 服务器的错误处理器
server.errorHandler(() => import('#exceptions/handler')) 
```

-----

## 处理异常 (Handling exceptions)

异常由异常处理程序类上的 **`handle` 方法**处理。默认情况下，在处理错误时会执行以下步骤：

1.  检查错误实例是否具有 **`handle` 方法**。如果存在，则调用 [error.handle](https://www.google.com/search?q=%23defining-the-handle-method) 方法并返回其响应。
2.  检查是否为 **`error.status` 代码**定义了**状态页**。如果存在，则渲染状态页。
3.  否则，使用**内容协商渲染器**渲染异常。

如果您想以不同方式处理**特定异常**，可以在 `handle` 方法中进行操作。请确保使用 **`ctx.response.send` 方法**发送响应，因为 `handle` 方法的返回值**会被丢弃**。

```ts
import { errors } from '@vinejs/vine'

export default class HttpExceptionHandler extends ExceptionHandler {
  async handle(error: unknown, ctx: HttpContext) {
    // 检查是否为 VineJS 验证错误
    if (error instanceof errors.E_VALIDATION_ERROR) { 
      // 手动发送 422 状态码和错误消息
      ctx.response.status(422).send(error.messages) 
      return // 返回，阻止执行 super.handle
    }

    // 将其他错误传递给父类处理
    return super.handle(error, ctx) 
  }
}
```

### 状态页 (Status pages)

**状态页**是您希望为给定或一系列状态代码渲染的**模板集合**。

状态代码范围可以定义为字符串表达式。**两个点** (`..`) 分隔起始和结束状态代码。

如果您正在创建 JSON 服务器，则可能不需要状态页。

```ts
import { StatusPageRange, StatusPageRenderer } from '@adonisjs/http-server/types'

export default class HttpExceptionHandler extends ExceptionHandler {
  // 定义状态页映射
  protected statusPages: Record<StatusPageRange, StatusPageRenderer> = { 
    // 渲染 404 错误
    '404': (_, { view }) => view.render('errors/not-found'), 
    // 渲染 500 到 599 范围的服务器错误
    '500..599': (_, { view }) => view.render('errors/server-error') 
  }
}
```

### 调试模式 (Debug mode)

**内容协商渲染器**处理未自处理且未转换为状态页的异常。

内容协商渲染器支持**调试模式**。它们可以使用 [Youch](https://www.npmjs.com/package/youch) npm 包在调试模式下解析并**美观打印**错误。

您可以使用异常处理程序类上的 **`debug` 属性**切换调试模式。但是，建议在**生产环境中关闭**调试模式，因为它会暴露有关应用程序的敏感信息。

```ts
export default class HttpExceptionHandler extends ExceptionHandler {
  protected debug = !app.inProduction // 仅在非生产环境中启用
}
```

-----

## 报告异常 (Reporting exceptions)

异常处理程序类上的 **`report` 方法**处理异常的报告。

该方法接收**错误**作为第一个参数，[**HTTP 上下文**](https://www.google.com/search?q=../concepts/http_context.md) 作为第二个参数。您不应从 `report` 方法中写入响应，而应仅使用上下文来读取请求信息。

### 记录异常 (Logging exceptions)

默认情况下，所有异常都使用 [**日志记录器**](https://www.google.com/search?q=../digging_deeper/logger.md) 进行报告。

  * 状态代码在 **`400..499` 范围**内的异常将以 **`warning` 级别**记录。
  * 状态代码 **`>=500`** 的异常将以 **`error` 级别**记录。
  * 所有其他异常将以 **`info` 级别**记录。

您可以通过从 **`context` 方法**返回一个对象来向日志消息添加**自定义属性**。

```ts
export default class HttpExceptionHandler extends ExceptionHandler {
  protected context(ctx: HttpContext) {
    return {
      requestId: ctx.requestId,
      userId: ctx.auth.user?.id, // 记录当前用户 ID
      ip: ctx.request.ip(),
    }
  }
}
```

### 忽略状态代码 (Ignoring status codes)

您可以通过 **`ignoreStatuses` 属性**定义一个状态代码数组，以**忽略**这些异常的报告。

```ts
export default class HttpExceptionHandler extends ExceptionHandler {
  protected ignoreStatuses = [
    401, // Unauthorized
    400, // Bad Request
    422, // Unprocessable Entity (常见于验证错误)
    403, // Forbidden
  ]
}
```

### 忽略错误 (Ignoring errors)

您也可以通过定义一个**错误代码**或**错误类**的数组来忽略异常。

```ts
import { errors } from '@adonisjs/core'
import { errors as sessionErrors } from '@adonisjs/session'

export default class HttpExceptionHandler extends ExceptionHandler {
  // 忽略具有特定代码的错误
  protected ignoreCodes = [ 
    'E_ROUTE_NOT_FOUND',
    'E_INVALID_SESSION'
  ]
}
```

可以使用 **`ignoreExceptions` 属性**忽略异常类数组。

```ts
import { errors } from '@adonisjs/core'
import { errors as sessionErrors } from '@adonisjs/session'

export default class HttpExceptionHandler extends ExceptionHandler {
  // 忽略特定类的错误
  protected ignoreExceptions = [ 
    errors.E_ROUTE_NOT_FOUND,
    sessionErrors.E_INVALID_SESSION,
  ]
}
```

### 自定义 `shouldReport` 方法 (Custom shouldReport method)

忽略状态代码或异常的逻辑编写在 [`shouldReport` 方法](https://www.google.com/search?q=%5Bhttps://github.com/adonisjs/http-server/blob/main/src/exception_handler.ts%23L155%5D\(https://github.com/adonisjs/http-server/blob/main/src/exception_handler.ts%23L155\)) 内部。如果需要，您可以**覆盖此方法**并定义自定义逻辑来忽略异常。

```ts
import { HttpError } from '@adonisjs/core/types/http'

export default class HttpExceptionHandler extends ExceptionHandler {
  protected shouldReport(error: HttpError) {
    // 返回一个布尔值：true 表示应该报告，false 表示应该忽略
  }
}
```

-----

## 自定义异常 (Custom exceptions)

您可以使用 **`make:exception` ace 命令**创建异常类。异常扩展自 `@adonisjs/core` 包中的 **`Exception` 类**。

另请参阅：[Make exception command](https://www.google.com/search?q=../references/commands.md%23makeexception)

```sh
node ace make:exception UnAuthorized
```

```ts
import { Exception } from '@adonisjs/core/exceptions'

// 自定义异常类
export default class UnAuthorizedException extends Exception {} 
```

您可以通过创建其新实例来引发异常。引发异常时，您可以为异常分配**自定义错误代码**和**状态代码**。

```ts
import UnAuthorizedException from '#exceptions/unauthorized_exception'

throw new UnAuthorizedException('You are not authorized', {
  status: 403, // HTTP 状态码
  code: 'E_UNAUTHORIZED' // 唯一的错误代码
})
```

错误和状态代码也可以定义为异常类上的**静态属性**。如果在抛出异常时未定义自定义值，则将使用静态值。

```ts
import { Exception } from '@adonisjs/core/exceptions'
export default class UnAuthorizedException extends Exception {
  static status = 403 // 静态默认状态码
  static code = 'E_UNAUTHORIZED' // 静态默认错误代码
}
```

### 定义 `handle` 方法 (Defining the `handle` method)

要**自处理**异常，您可以在异常类上定义 **`handle` 方法**。此方法应使用 `ctx.response.send` 方法将错误转换为 HTTP 响应。

`error.handle` 方法接收**错误实例**作为第一个参数，**HTTP 上下文**作为第二个参数。

```ts
import { Exception } from '@adonisjs/core/exceptions'
import { HttpContext } from '@adonisjs/core/http'

export default class UnAuthorizedException extends Exception {
  async handle(error: this, ctx: HttpContext) {
    // 自行处理响应逻辑
    ctx.response.status(error.status).send(error.message) 
  }
}
```

### 定义 `report` 方法 (Define the `report` method)

您可以在异常类上实现 **`report` 方法**来**自处理**异常报告。`report` 方法接收**错误实例**作为第一个参数，**HTTP 上下文**作为第二个参数。

```ts
import { Exception } from '@adonisjs/core/exceptions'
import { HttpContext } from '@adonisjs/core/http'

export default class UnAuthorizedException extends Exception {
  async report(error: this, ctx: HttpContext) {
    // 自行处理报告逻辑，例如发送到外部服务
    ctx.logger.error({ err: error }, error.message) 
  }
}
```

-----

## 缩小错误类型 (Narrowing down the error type)

框架核心和其他官方包会导出它们引发的异常。您可以使用 **`instanceof` 检查**来验证错误是否是特定异常的实例。例如：

```ts
import { errors } from '@adonisjs/core'

try {
  router.builder().make('articles.index')
} catch (error: unknown) {
  // 检查是否为 E_CANNOT_LOOKUP_ROUTE 异常
  if (error instanceof errors.E_CANNOT_LOOKUP_ROUTE) { 
    // 处理路由查找错误
  }
}
```

-----

## 已知错误 (Known errors)

请查看 [**异常参考指南**](https://www.google.com/search?q=../references/exceptions.md) 以查看已知错误列表。