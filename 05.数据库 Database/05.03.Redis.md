# Redis

您可以使用 **`@adonisjs/redis` 包**在您的 AdonisJS 应用程序中使用 **Redis**。该包是 [ioredis](https://github.com/redis/ioredis) 之上的一个轻量级封装，提供了更好的**开发者体验 (DX)**，尤其是在 **Pub/Sub** 方面以及**自动管理多个 Redis 连接**。

-----

## 安装 (Installation)

使用以下命令安装和配置该包：

```sh
node ace add @adonisjs/redis
```

:::disclosure{title="查看 add 命令执行的步骤"}

1.  使用检测到的包管理器安装 `@adonisjs/redis` 包。
2.  在 `adonisrc.ts` 文件中注册以下**服务提供程序**。
    ```ts
    {
      providers: [
        // ...other providers
        () => import('@adonisjs/redis/redis_provider')
      ]
    }
    ```
3.  创建 **`config/redis.ts` 文件**。此文件包含您的 Redis 服务器的连接配置。
4.  定义以下**环境变量及其验证规则**。
    ```dotenv
    REDIS_HOST=127.0.0.1
    REDIS_PORT=6379
    REDIS_PASSWORD=
    ```

:::

-----

## 配置 (Configuration)

Redis 包的配置存储在 **`config/redis.ts` 文件**中。

另请参阅：[配置文件 Stub](https://github.com/adonisjs/redis/blob/main/stubs/config/redis.stub)

```ts
import env from '#start/env'
import { defineConfig } from '@adonisjs/redis'

const redisConfig = defineConfig({
  connection: 'main', // 默认连接
  connections: {
    main: {
      host: env.get('REDIS_HOST'),
      port: env.get('REDIS_PORT'),
      password: env.get('REDIS_PASSWORD', ''),
      db: 0,
      keyPrefix: '',
    },
  },
})

export default redisConfig
```

\<dl\>
\<dt\> `connection` \</dt\>
\<dd\>

`connection` 属性定义了**默认使用的连接**。当您在没有选择显式连接的情况下运行 Redis 命令时，它们将针对默认连接执行。

\</dd\>

\<dt\> `connections` \</dt\>
\<dd\>

`connections` 属性是**多个命名连接的集合**。您可以在此对象中定义一个或多个连接，并使用 `redis.connection()` 方法在它们之间切换。

每个命名连接配置都与 [ioredis 接受的配置](https://redis.github.io/ioredis/index.html#RedisOptions) 相同。

\</dd\>
\</dl\>

### 通过 Socket 连接 (Connect via Socket)

您可以配置 Redis 使用 **Unix socket** 进行连接。在您的 Redis 配置对象中使用 **`path` 属性**，并提供到 socket 的文件系统路径。

```ts
import env from '#start/env'
import { defineConfig } from '@adonisjs/redis'

const redisConfig = defineConfig({
  connection: 'main',
  connections: {
    main: {
      path: env.get('REDIS_SOCKET_PATH'), // 使用 path 属性代替 host/port
      db: 0,
      keyPrefix: '',
    },
  },
})

export default redisConfig
```

-----

### 配置集群 (Configuring clusters)

如果您在连接配置中定义了**主机数组**，`@adonisjs/redis` 包将创建一个 [**集群连接**](https://github.com/redis/ioredis#cluster)。例如：

```ts
const redisConfig = defineConfig({
  connections: {
    main: {
      clusters: [ // 定义集群节点数组
        { host: '127.0.0.1', port: 6380 },
        { host: '127.0.0.1', port: 6381 },
      ],
      clusterOptions: {
        scaleReads: 'slave',
        slotsRefreshTimeout: 10 * 1000,
      },
    },
  },
})
```

### 配置 Sentinel (Configuring sentinels)

您可以通过在连接配置中定义一个 **Sentinel 节点数组**来配置 Redis 连接使用 **Sentinel**。例如：

另请参阅：[IORedis 文档关于 Sentinel 配置](https://github.com/redis/ioredis?tab=readme-ov-file#sentinel)

```ts
const redisConfig = defineConfig({
  connections: {
    main: {
      sentinels: [ // 定义 Sentinel 节点数组
        { host: 'localhost', port: 26379 },
        { host: 'localhost', port: 26380 },
      ],
      name: 'mymaster', // master 的名称
    },
  },
})
```

-----

## 用法 (Usage)

您可以使用包导出的 **`redis` 服务**来运行 Redis 命令。Redis 服务是一个**单例对象**，使用您在 `config/redis.ts` 文件中定义的配置进行配置。

:::note

请查阅 [ioredis](https://redis.github.io/ioredis/classes/Redis.html) 文档以查看可用方法的列表。由于我们是 IORedis 之上的一个封装，因此命令 API 是相同的。

:::

```ts
import redis from '@adonisjs/redis/services/main'

await redis.set('username', 'virk')
const username = await redis.get('username')
```

### 切换连接 (Switching between connections)

使用 **`redis` 服务**执行的命令将针对配置文件中定义的**默认连接**调用。但是，您可以通过**首先获取特定连接的实例**来在该连接上执行命令。

**`.connection()` 方法**会创建并缓存连接实例，供进程的生命周期使用。

```ts
import redis from '@adonisjs/redis/services/main'

// 获取名为 'main' 的连接实例
const redisMain = redis.connection('main') 

await redisMain.set('username', 'virk')
const username = await redisMain.get('username')
```

### 退出连接 (Quitting connections)

连接是**长久存在的**，每次调用 `.connection()` 方法时都会获得相同的实例。您可以使用 **`quit` 方法**退出连接。使用 **`disconnect` 方法**强制结束连接。

```ts
import redis from '@adonisjs/redis/services/main'

await redis.quit('main') // 优雅退出 main 连接
await redis.disconnect('main') // 强制断开 main 连接
```

```ts
import redis from '@adonisjs/redis/services/main'

const redisMain = redis.connection('main')
redisMain.quit() // 使用连接实例退出
redisMain.disconnect() // 使用连接实例强制断开
```

-----

## 错误处理 (Error handling)

Redis 连接在应用程序的生命周期中随时可能失败。因此，捕获错误并制定**重试策略**至关重要。

默认情况下，AdonisJS 将使用 [应用程序日志器](https://www.google.com/search?q=../digging_deeper/logger.md) 记录 Redis 连接错误，并在**永久关闭连接之前重试连接十次**。重试策略在 `config/redis.ts` 文件中为每个连接定义。

另请参阅：[IORedis 文档关于自动重连](https://github.com/redis/ioredis#auto-reconnect)

```ts
// title: config/redis.ts
{
  main: {
    host: env.get('REDIS_HOST'),
    port: env.get('REDIS_PORT'),
    password: env.get('REDIS_PASSWORD', ''),
    retryStrategy(times) { // 自定义重试策略
      return times > 10 ? null : times * 50 // 重试 10 次，每次间隔 times * 50ms
    },
  },
}
```

您可以使用 **`.doNotLogErrors` 方法**禁用默认的错误报告器。这样做将从 Redis 连接中移除 **`error` 事件监听器**。

```ts
import redis from '@adonisjs/redis/services/main'

/**
 * 禁用默认错误报告器
 */
redis.doNotLogErrors()

redis.on('connection', (connection) => {
  /**
   * 确保始终定义一个错误监听器。
   * 否则，应用程序将崩溃
   */
  connection.on('error', (error) => {
    console.log(error)
  })
})
```

-----

## Pub/Sub (发布/订阅)

Redis 需要**多个连接**才能发布和订阅频道。**订阅者连接**不能执行订阅新频道/模式和取消订阅以外的操作。

使用 `@adonisjs/redis` 包时，您无需手动创建订阅者连接；我们将为您处理。当您**第一次调用 `subscribe` 方法**时，我们将**自动创建一个新的订阅者连接**。

```ts
import redis from '@adonisjs/redis/services/main'

redis.subscribe('user:add', function (message) {
  console.log(message)
})
```

### IORedis 与 AdonisJS 之间的 API 差异 (API differences between IORedis and AdonisJS)

使用 `ioredis` 时，您必须使用**两种不同的 API** 来订阅频道和监听新消息。然而，使用 AdonisJS 封装时，**`subscribe` 方法**同时处理了这两件事。

:::caption{for="info"}
**使用 IORedis**
:::

```ts
// 监听消息的事件
redis.on('message', (channel, messages) => { 
  console.log(message)
})

// 订阅频道
redis.subscribe('user:add', (error, count) => { 
  if (error) {
    console.log(error)
  }
})
```

:::caption{for="info"}
**使用 AdonisJS**
:::

```ts
// 一个方法完成订阅和监听
redis.subscribe('user:add', (message) => { 
  console.log(message)
},
{
  onError(error) { // 可选的错误处理
    console.log(error)
  },
  onSubscription(count) { // 可选的订阅确认回调
    console.log(count)
  },
})
```

### 发布消息 (Publishing messages)

您可以使用 **`publish` 方法**发布消息。该方法接受**频道名称**作为第一个参数，**要发布的数据**作为第二个参数。

```ts
redis.publish(
  'user:add',
  JSON.stringify({ // 消息通常以字符串形式发送
    id: 1,
    username: 'virk',
  })
)
```

### 订阅模式 (Subscribing to patterns)

您可以使用 **`psubscribe` 方法**订阅**模式**（pattern）。与 `subscribe` 方法类似，如果订阅者连接不存在，它将创建一个。

```ts
redis.psubscribe('user:*', (channel, message) => { // 订阅所有 'user:' 开头的频道
  console.log(channel) // 打印收到消息的实际频道名
  console.log(message)
})

redis.publish(
  'user:add', // 消息会被 'user:*' 模式捕获
  JSON.stringify({
    id: 1,
    username: 'virk',
  })
)
```

### 取消订阅 (Unsubscribing)

您可以使用 **`unsubscribe`** 和 **`punsubscribe`** 方法取消订阅**频道**或**模式**。

```ts
await redis.unsubscribe('user:add')
await redis.punsubscribe('user:*add*')
```

-----

## 使用 Lua 脚本 (Using Lua scripts)

您可以将 **Lua 脚本**注册为 Redis 服务的命令，它们将被应用于所有连接。

另请参阅：[IORedis 文档关于 Lua 脚本](https://github.com/redis/ioredis#lua-scripting)

```ts
import redis from '@adonisjs/redis/services/main'

// 注册名为 'release' 的 Lua 命令
redis.defineCommand('release', { 
  numberOfKeys: 2, // 脚本中使用的 KEYS 数量
  lua: `
    redis.call('zrem', KEYS[2], ARGV[1])
    redis.call('zadd', KEYS[1], ARGV[2], ARGV[1])
    return true
  `,
})
```

定义命令后，您可以使用 **`runCommand` 方法**执行它。首先定义所有 **`KEYS`**，然后是 **`ARGV`**。

```ts
redis.runCommand(
  'release', // 命令名称
  'jobs:completed', // key 1 (KEYS[1])
  'jobs:running', // key 2 (KEYS[2])
  '11023', // argv 1 (ARGV[1])
  100 // argv 2 (ARGV[2])
)
```

可以在**显式连接**上执行相同的命令。

```ts
redis.connection('jobs').runCommand(
  'release', // command name
  'jobs:completed', // key 1
  'jobs:running', // key 2
  '11023', // argv 1
  100 // argv 2
)
```

最后，您还可以为**特定的连接实例**定义命令。例如：

```ts
redis.on('connection', (connection) => {
  if (connection.connectionName === 'jobs') {
    connection.defineCommand('release', {
      numberOfKeys: 2,
      lua: `
        redis.call('zrem', KEYS[2], ARGV[1])
        redis.call('zadd', KEYS[1], ARGV[2], ARGV[1])
        return true
      `,
    })
  }
})
```

-----

## 转换参数和回复 (Transforming arguments and replies)

您可以使用 **`redis.Command` 属性**定义**参数转换器**和**回复转换器**。API 与 [IORedis API](https://github.com/redis/ioredis#transforming-arguments--replies) 相同。

```ts
// title: 参数转换器 (Argument transformer)
import redis from '@adonisjs/redis/services/main'

// 为 HMSET 命令设置参数转换器
redis.Command.setArgumentTransformer('hmset', (args) => {
  if (args.length === 2) {
    if (args[1] instanceof Map) {
      // utils 是 ioredis 的内部模块
      return [args[0], ...utils.convertMapToArray(args[1])] 
    }
    if (typeof args[1] === 'object' && args[1] !== null) {
      return [args[0], ...utils.convertObjectToArray(args[1])]
    }
  }
  return args
})
```

```ts
// title: 回复转换器 (Reply transformer)
import redis from '@adonisjs/redis/services/main'

// 为 HGETALL 命令设置回复转换器
redis.Command.setReplyTransformer('hgetall', (result) => { 
  if (Array.isArray(result)) {
    const obj = {}
    for (let i = 0; i < result.length; i += 2) {
      obj[result[i]] = result[i + 1]
    }
    return obj // 将数组回复转换为对象
  }
  return result
})
```

-----

## 事件 (Events)

以下是 Redis 连接实例发出的事件列表。

### `connect` / `subscriber:connect`

建立连接时发出。**`subscriber:connect`** 事件在建立订阅者连接时发出。

```ts
import redis from '@adonisjs/redis/services/main'

redis.on('connection', (connection) => {
  connection.on('connect', () => {})
  connection.on('subscriber:connect', () => {})
})
```

### `wait`

当连接处于 **`wait` 模式**时发出，因为配置中设置了 `lazyConnect` 选项。执行第一个命令后，连接将从 `wait` 状态转移。

```ts
import redis from '@adonisjs/redis/services/main'

redis.on('connection', (connection) => {
  connection.on('wait', () => {})
})
```

### `ready` / `subscriber:ready`

此事件将在 `connect` 事件之后立即发出，除非您在配置中启用了 `enableReadyCheck` 标志。在这种情况下，我们将等待 Redis 服务器报告它准备好接受命令。

```ts
import redis from '@adonisjs/redis/services/main'

redis.on('connection', (connection) => {
  connection.on('ready', () => {})
  connection.on('subscriber:ready', () => {})
})
```

### `error` / `subscriber:error`

无法连接到 Redis 服务器时发出。请参阅 [错误处理](https://www.google.com/search?q=%23error-handling) 以了解 AdonisJS 如何处理连接错误。

```ts
import redis from '@adonisjs/redis/services/main'

redis.on('connection', (connection) => {
  connection.on('error', () => {})
  connection.on('subscriber:error', () => {})
})
```

### `close` / `subscriber:close`

连接关闭时发出。IORedis 可能会根据重试策略在发出 `close` 事件后尝试重新建立连接。

```ts
import redis from '@adonisjs/redis/services/main'

redis.on('connection', (connection) => {
  connection.on('close', () => {})
  connection.on('subscriber:close', () => {})
})
```

### `reconnecting` / `subscriber:reconnecting`

在 `close` 事件后尝试重新连接到 Redis 服务器时发出。

```ts
import redis from '@adonisjs/redis/services/main'

redis.on('connection', (connection) => {
  connection.on('reconnecting', ({ waitTime }) => {
    console.log(waitTime)
  })
  connection.on('subscriber:reconnecting', ({ waitTime }) => {
    console.log(waitTime)
  })
})
```

### `end` / `subscriber:end`

连接已关闭，并且不会再进行任何进一步的重连时发出。这应该是连接生命周期的结束。

```ts
import redis from '@adonisjs/redis/services/main'

redis.on('connection', (connection) => {
  connection.on('end', () => {})
  connection.on('subscriber:end', () => {})
})
```

### `node:added`

连接到新的集群节点时发出（仅适用于集群实例）。

```ts
import redis from '@adonisjs/redis/services/main'

redis.on('connection', (connection) => {
  connection.on('node:added', () => {})
})
```

### `node:removed`

移除集群节点时发出（仅适用于集群实例）。

```ts
import redis from '@adonisjs/redis/services/main'

redis.on('connection', (connection) => {
  connection.on('node:removed', () => {})
})
```

### `node:error`

无法连接到集群节点时发出（仅适用于集群实例）。

```ts
import redis from '@adonisjs/redis/services/main'

redis.on('connection', (connection) => {
  connection.on('node:error', ({ error, address }) => {
    console.log(error, address)
  })
})
```

### `subscription:ready` / `psubscription:ready`

在给定**频道**或**模式**上的订阅已建立时发出。

```ts
import redis from '@adonisjs/redis/services/main'

redis.on('connection', (connection) => {
  connection.on('subscription:ready', ({ count }) => {
    console.log(count)
  })
  connection.on('psubscription:ready', ({ count }) => {
    console.log(count)
  })
})
```

### `subscription:error` / `psubscription:error`

无法订阅频道或模式时发出。

```ts
import redis from '@adonisjs/redis/services/main'

redis.on('connection', (connection) => {
  connection.on('subscription:error', () => {})
  connection.on('psubscription:error', () => {})
})
```