# Vite (前端资源打包)

AdonisJS 使用 [**Vite**](https://vitejs.dev/) 来捆绑您应用程序的**前端资源**。我们提供了一个官方集成包，它执行了将 Vite 与 AdonisJS 等后端框架集成所需的所有繁重工作。它包括：

  * 将 Vite **开发服务器**嵌入到 AdonisJS 内部。
  * 一个**专用的 Vite 插件**，用于简化配置选项。
  * **Edge 辅助函数和标签**，用于生成由 Vite 处理的资源的 URL。
  * 访问 [**Vite 运行时 API**](https://vitejs.dev/guide/api-vite-runtime.html#vite-runtime-api) 以执行**服务器端渲染 (SSR)**。

Vite 被嵌入到 **AdonisJS 开发服务器**内部，并且所有应由 Vite 处理的请求都通过 **AdonisJS 中间件**代理给它。这使我们能够直接访问 Vite 的运行时 API 来执行服务器端渲染 (SSR) 并管理**单个开发服务器**。这也意味着资源是**直接由 AdonisJS** 服务的，而不是由一个单独的进程服务。

:::tip
还在使用 `@adonisjs/vite 2.x`？[请参阅迁移指南](https://github.com/adonisjs/vite/releases/tag/v3.0.0) 以升级到最新版本。
:::

-----

## 安装 (Installation)

首先，请确保安装了至少以下版本的 AdonisJS：

  * `@adonisjs/core`: 6.9.1 或更高版本
  * `@adonisjs/assembler`: 7.7.0 或更高版本

然后安装并配置 **`@adonisjs/vite` 包**。下面的命令将安装该包和 `vite`，并通过创建必要的配置文件来配置项目。

```sh
// title: npm
node ace add @adonisjs/vite
```

:::disclosure{title="查看配置命令执行的步骤"}

1.  在 `adonisrc.ts` 文件中注册以下服务提供程序。
    ```ts
    {
      providers: [
        // ...other providers
        () => import('@adonisjs/vite/vite_provider')
      ]
    }
    ```
2.  创建 `vite.config.ts` 和 `config/vite.ts` 配置文件。
3.  创建前端入口文件，即 `resources/js/app.js`。

:::

完成后，将以下内容添加到您的 **`adonisrc.ts` 文件**中。

```ts
import { defineConfig } from '@adonisjs/core/build/standalone'

export default defineConfig({
  // 关闭 Assembler 的资产捆绑管理
  assetsBundler: false, 
  hooks: {
    // 注册 Vite 构建钩子
    onBuildStarting: [() => import('@adonisjs/vite/build_hook')], 
  },
})
```

`assetsBundler` 属性设置为 `false` 以关闭由 AdonisJS Assembler 完成的**资产捆绑器管理**。

`hooks` 属性注册 `@adonisjs/vite/build_hook` 以执行 **Vite 构建过程**。有关更多信息，请参阅 [Assembler 钩子](https://www.google.com/search?q=../concepts/assembler_hooks.md)。

-----

## 配置 (Configuration)

设置过程创建了两个配置文件。**`vite.config.ts` 文件**用于配置 Vite 捆绑器，而 **`config/vite.ts` 文件**用于后端上的 AdonisJS。

### Vite 配置文件 (`vite.config.ts`)

`vite.config.ts` 文件是 Vite 使用的**常规配置文件**。根据您的项目要求，您可以在此文件内部安装和注册额外的 Vite 插件。

默认情况下，`vite.config.ts` 文件使用 **AdonisJS 插件**，该插件接受以下选项。

```ts
// title: vite.config.ts
import { defineConfig } from 'vite'
import adonisjs from '@adonisjs/vite/client'

export default defineConfig({
  plugins: [
    adonisjs({
      entrypoints: ['resources/js/app.js'], // 前端入口点
      reload: ['resources/views/**/*.edge'], // 监听文件更改并重新加载浏览器
    }),
  ]
})
```

\<dl\>

\<dt\> `entrypoints` \</dt\>

\<dd\>

`entrypoints` 指的是您的前端代码库的**入口文件**。通常，它将是一个带有附加导入的 JavaScript 或 TypeScript 文件。每个入口点将生成一个**单独的输出捆绑包**。

您也可以定义**多个入口点**。例如，一个用于面向用户的应用程序，另一个用于管理面板。

\</dd\>

\<dt\> `buildDirectory` \</dt\>

\<dd\>

`buildDirectory` 选项定义了到**输出目录的相对路径**。该选项值作为 [`build.outDir`](https://www.google.com/search?q=%5Bhttps://vitejs.dev/config/build-options.html%23build-outdir%5D\(https://vitejs.dev/config/build-options.html%23build-outdir\)) 选项提供给 Vite。

如果您决定更改默认值，请确保也更新 `config/vite.ts` 文件中的 `buildDirectory` 路径。

**默认值：`public/assets`**

\</dd\>

\<dt\> `reload` \</dt\>

\<dd\>

它包含一个**全局模式数组**，用于**监听文件更改并重新加载浏览器**。默认情况下，我们监听 Edge 模板。但是，您也可以配置其他模式。

\</dd\>

\<dt\> `assetsUrl` \</dt\>

\<dd\>

它包含在生产环境中为资源生成链接时要添加的 **URL 前缀**。如果您将 Vite 输出上传到 CDN，则此属性的值应为 CDN 服务器 URL。

请确保更新后端配置以使用相同的 `assetsUrl` 值。

\</dd\>
\</dl\>

-----

### AdonisJS 配置文件 (`config/vite.ts`)

AdonisJS 在后端使用 **`config/vite.ts` 文件**来了解 Vite 构建过程的**输出路径**。

```ts
// title: config/vite.ts
import { defineConfig } from '@adonisjs/vite'

const viteBackendConfig = defineConfig({
  buildDirectory: 'public/assets', // Vite 构建输出目录
  assetsUrl: '/assets', // 生产环境中资源的 URL 前缀
})

export default viteBackendConfig
```

\<dl\>

\<dt\> `buildDirectory` \</dt\>

\<dd\>

它包含 Vite 的构建输出目录的路径。如果更改了 `vite.config.ts` 文件中的默认值，也必须更新此后端配置。

\</dd\>

\<dt\> `assetsUrl` \</dt\>

\<dd\>

在生产环境中为资源生成链接时要添加的 URL 前缀。如果您将 Vite 输出上传到 CDN，则此属性的值应为 CDN 服务器 URL。

\</dd\>

\<dt\> `scriptAttributes` \</dt\>

\<dd\>

您可以使用 `scriptAttributes` 属性来设置使用 **`@vite` 标签**生成的 **`<script>` 标签**上的属性。属性是键值对的集合。

```ts
// title: config/vite.ts
defineConfig({
  scriptAttributes: {
    defer: true,
    async: true,
  }
})
```

\</dd\>

\<dt\> `styleAttributes` \</dt\>

\<dd\>

您可以使用 `styleAttributes` 属性来设置使用 **`@vite` 标签**生成的 **`<link>` 标签**上的属性。属性是键值对的集合。

```ts
// title: config/vite.ts
defineConfig({
  styleAttributes: {
    'data-turbo-track': 'reload'
  }
})
```

您还可以通过将函数分配给 `styleAttributes` 选项来**有条件地**应用属性。

```ts
defineConfig({
  styleAttributes: ({ src, url }) => {
    if (src === 'resources/css/admin.css') {
      return {
        'data-turbo-track': 'reload'
      }
    }
    return {}
  }
})
```

\</dd\>

\</dl\>

-----

## 前端资源文件夹结构 (Folder structure for frontend assets)

AdonisJS 在技术上不强制要求存储前端资源的文件夹结构。您可以根据自己的喜好组织它们。

但是，我们建议将前端资源存储在 **`resources` 文件夹**内部，每个资源类别位于其子目录中。

```
resources
└── css
└── js
└── fonts
└── images
```

Vite 输出将在 **`public/assets` 文件夹**中。我们选择 `/assets` 子目录，以便您可以继续将 `public` 文件夹用于您不希望使用 Vite 处理的其他静态文件。

-----

## 启动开发服务器 (Starting the dev server)

您可以像往常一样启动应用程序，AdonisJS 将**自动**将所需的请求代理给 Vite。

```sh
node ace serve --hmr
```

-----

## 在 Edge 模板中包含入口点 (Including entrypoints in Edge templates)

您可以使用 **`@vite` Edge 标签**渲染在 `vite.config.ts` 文件中定义的**入口点**的 **`<script>` 和 `<link>` 标签**。该标签接受一个入口点数组，并返回相应的标签。

```edge
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    {{-- 渲染入口点所需的 script 和 link 标签 --}}
    @vite(['resources/js/app.js']) 
</head>
<body>
    
</body>
</html>
```

我们建议在 **JavaScript 文件**中导入 CSS 文件，而不是将它们单独注册为入口点。例如：

```
resources
└── css
    └── app.css
└── js
    └── app.js
```

```js
// title: resources/js/app.js
import '../css/app.css'
```

-----

## 在 Edge 模板中引用资源 (Referencing assets inside Edge templates)

Vite 创建了由入口点导入的文件的**依赖图**，并根据捆绑的输出来**自动更新它们的路径**。但是，Vite **不知道 Edge 模板**，也无法检测它们引用的资源。

因此，我们提供了一个 Edge 辅助函数 **`asset`**，您可以使用它为由 Vite 处理的文件创建 URL。在以下示例中：

  * 在开发期间，`asset` 辅助函数将返回指向 **Vite 开发服务器**的 URL。
  * 在生产期间，返回指向**输出文件名**的 URL。

<!-- end list -->

```edge
<link rel="stylesheet" href="{{ asset('resources/css/app.css') }}">
```

```html
// title: 开发环境中的输出
<link rel="stylesheet" href="http://localhost:5173/resources/css/app.css">
```

```html
// title: 生产环境中的输出
<link rel="stylesheet" href="/assets/app-3bc29777.css">
```

-----

## 使用 Vite 处理额外资源 (Processing additional assets with Vite)

Vite 会忽略**未被前端代码导入**的静态资源。这可能是仅在 Edge 模板内部引用的静态图像、字体或 SVG 图标。

因此，您必须使用 Vite 的 [**Glob imports**](https://vitejs.dev/guide/features.html#glob-import) API 来通知 Vite 这些资源的存在。

在以下示例中，我们要求 Vite 处理 `resources/images` 目录中的所有文件。此代码应写在**入口文件**内部。

```js
// title: resources/js/app.js
// 使用 Glob 导入来让 Vite 知道要处理这些静态资源
import.meta.glob(['../images/**']) 
```

现在，您可以在 Edge 模板中引用图像，如下所示。

```edge
<img src="{{ asset('resources/images/hero.jpg') }}" />
```

-----

## 配置 TypeScript (Configuring TypeScript)

如果您计划在前端代码库中使用 **TypeScript**，请在 **`resources` 目录**内部创建一个额外的 **`tsconfig.json` 文件**。Vite 和您的代码编辑器将自动使用此配置文件来处理 `resources` 目录内部的 TypeScript 源代码。

```json
// title: resources/tsconfig.json
{
  "extends": "../tsconfig.json",
  "compilerOptions": {
    "baseUrl": ".",
    "lib": ["DOM"],
    "jsx": "preserve", // 如果您使用 React
    "paths": {
      "@/*": ["./js/*"]
    }
  }
}
```

-----

## 启用 React 的 HMR (Enabling HMR with React)

要在开发期间启用 [**react-refresh**](https://www.npmjs.com/package/react-refresh)，您必须使用 **`@viteReactRefresh` Edge 标签**。它应该写在您使用 `@vite` 标签包含入口点**之前**。

```edge
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    {{-- 必须在 @vite 之前 --}}
    @viteReactRefresh() 
    @vite(['resources/js/app.js'])
</head>
<body>
    
</body>
</html>
```

完成后，您可以像在常规 Vite 项目中一样配置 **React 插件**。

```ts
import { defineConfig } from 'vite'
import adonisjs from '@adonisjs/vite/client'
import react from '@vitejs/plugin-react'

export default defineConfig({
  plugins: [
    adonisjs({
      entrypoints: ["resources/js/app.js"],
    }),
    react(), // 注册 React 插件
  ],
})
```

-----

## 部署资源到 CDN (Deploying assets to a CDN)

使用 Vite 创建生产构建后，您可以将捆绑的输出上传到 **CDN 服务器**来提供文件。

但是，在此之前，您必须在 **Vite** 和 **AdonisJS** 中注册您的 **CDN 服务器的 URL**，以便 `manifest.json` 文件或延迟加载块中的输出 URL 应指向您的 CDN 服务器。

您必须在 **`vite.config.ts`** 和 **`config/vite.ts` 文件**中定义 **`assetsUrl`**。

```ts
// title: vite.config.ts
import { defineConfig } from 'vite'
import adonisjs from '@adonisjs/vite/client'

export default defineConfig({
  plugins: [
    adonisjs({
      entrypoints: ['resources/js/app.js'],
      reloads: ['resources/views/**/*.edge'],
      assetsUrl: 'https://cdn.example.com/', // CDN URL
    }),
  ]
})
```

```ts
// title: config/vite.ts
import { defineConfig } from '@adonisjs/vite'

const viteBackendConfig = defineConfig({
  buildDirectory: 'public/assets',
  assetsUrl: 'https://cdn.example.com/', // CDN URL
})

export default viteBackendConfig
```

-----

## 高级概念 (Advanced concepts)

### 中间件模式 (Middleware Mode)

在较旧版本的 AdonisJS 中，Vite 是作为一个**单独的进程**生成的，并有自己的开发服务器。

在 3.x 版本中，Vite 被**嵌入到 AdonisJS 开发服务器**内部，并且所有应由 Vite 处理的请求都通过 **AdonisJS 中间件**代理给它。

中间件模式的优点是我们可以直接访问 **Vite 的运行时 API** 来执行**服务器端渲染 (SSR)**，并且只需要管理**单个开发服务器**。

您可以在 [Vite 文档](https://vitejs.dev/guide/ssr#setting-up-the-dev-server) 中阅读有关中间件模式的更多信息。

### Manifest 文件 (Manifest file)

Vite 会在资产的生产构建旁边生成 [**Manifest 文件**](https://vitejs.dev/guide/backend-integration.html)。

Manifest 文件包含由 Vite 处理的**资源的 URL**，AdonisJS 使用此文件来创建在 Edge 模板中引用的资源的 URL，无论是使用 **`asset` 辅助函数**还是 **`@vite` 标签**。