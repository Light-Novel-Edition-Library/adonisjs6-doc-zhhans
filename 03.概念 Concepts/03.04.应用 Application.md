# 应用 (Application)

[Application](https://github.com/adonisjs/application/blob/main/src/application.ts) 类负责将 AdonisJS 应用程序连接在一起的所有繁重工作。您可以使用此类来了解应用程序运行的环境、获取应用程序的当前状态，或生成特定目录的路径。

另请参阅：[应用程序生命周期](https://www.google.com/search?q=./application_lifecycle.md)

## 环境 (Environment)

环境指的是应用程序的运行时环境。应用程序始终在以下已知环境之一中启动。

  * **`web`** 环境指为 HTTP 服务器启动的进程。
  * **`console`** 环境指除 REPL 命令之外的 Ace 命令。
  * **`repl`** 环境指使用 `node ace repl` 命令启动的进程。
  * 最后，**`test`** 环境指使用 `node ace test` 命令启动的进程。

您可以使用 `getEnvironment` 方法访问应用程序环境。

```ts
import app from '@adonisjs/core/services/app'

console.log(app.getEnvironment())
```

您也可以在应用程序启动之前切换应用程序环境。REPL 命令就是一个很好的例子。

`node ace repl` 命令在 `console` 环境中启动应用程序，但在显示 REPL 提示符之前，该命令会在内部将环境切换为 `repl`。

```ts
if (!app.isBooted) {
	app.setEnvironment('repl')
}
```

## Node 环境 (Node environment)

您可以使用 `nodeEnvironment` 属性访问 Node.js 环境。该值是对 `NODE_ENV` 环境变量的引用。但是，该值会被进一步标准化以保持一致性。

```ts
import app from '@adonisjs/core/services/app'

console.log(app.nodeEnvironment)
```

| NODE\_ENV | 标准化为 (Normalized to) |
| :--- | :--- |
| dev | development |
| develop | development |
| stage | staging |
| prod | production |
| testing | test |

此外，您可以使用以下属性作为简写来了解当前环境。

  * `inProduction`：检查应用程序是否在生产环境中运行。
  * `inDev`：检查应用程序是否在开发环境中运行。
  * `inTest`：检查应用程序是否在测试环境中运行。

<!-- end list -->

```ts
import app from '@adonisjs/core/services/app'

// 是否在生产环境
app.inProduction
app.nodeEnvironment === 'production'

// 是否在开发环境
app.inDev
app.nodeEnvironment === 'development'

// 是否在测试环境
app.inTest
app.nodeEnvironment === 'test'
```

## 状态 (State)

状态指应用程序的当前状态。您可以访问的框架功能在很大程度上取决于应用程序的当前状态。例如，在应用程序处于 `booted`（已引导）状态之前，您无法访问[容器绑定](https://www.google.com/search?q=./dependency_injection.md%23container-bindings)或[容器服务](https://www.google.com/search?q=./container_services.md)。

应用程序始终处于以下已知状态之一。

  * **`created`**：这是应用程序的默认状态。
  * **`initiated`**：在此状态下，我们解析/验证环境变量并处理 `adonisrc.ts` 文件。
  * **`booted`**：应用程序服务提供者在此状态下被注册并引导。
  * **`ready`**：这就绪状态因不同环境而异。例如，在 `web` 环境中，就绪状态意味着应用程序已准备好接受新的 HTTP 请求。
  * **`terminated`**：应用程序已终止，进程将很快退出。在 `web` 环境中，应用程序将不再接受新的 HTTP 请求。

<!-- end list -->

```ts
import app from '@adonisjs/core/services/app'

console.log(app.getState())
```

您还可以使用以下简写属性来了解应用程序是否处于给定状态。

```ts
import app from '@adonisjs/core/services/app'

// App 已引导 (booted)
app.isBooted
app.getState() !== 'created' && app.getState() !== 'initiated'

// App 已就绪 (ready)
app.isReady
app.getState() === 'ready'

// 正在优雅地尝试终止 App
app.isTerminating

// App 已终止 (terminated)
app.isTerminated
app.getState() === 'terminated'
```

## 监听进程信号 (Listening for process signals)

您可以使用 `app.listen` 或 `app.listenOnce` 方法监听 [POSIX 信号](https://man7.org/linux/man-pages/man7/signal.7.html)。在底层，我们向 Node.js 的 `process` 对象注册了监听器。

```ts
import app from '@adonisjs/core/services/app'

// 监听 SIGTERM 信号
app.listen('SIGTERM', () => {
})

// 监听一次 SIGTERM 信号
app.listenOnce('SIGTERM', () => {
})
```

有时，您可能希望有条件地注册监听器。例如，仅在 pm2 环境内运行时监听 `SIGINT` 信号。

您可以使用 `listenIf` 或 `listenOnceIf` 方法来有条件地注册监听器。仅当第一个参数的值为真 (truthy) 时，才会注册监听器。

```ts
import app from '@adonisjs/core/services/app'

app.listenIf(app.managedByPm2, 'SIGTERM', () => {
})

app.listenOnceIf(app.managedByPm2, 'SIGTERM', () => {
})
```

## 通知父进程 (Notifying parent process)

如果您的应用程序作为子进程启动，您可以使用 `app.notify` 方法向父进程发送消息。在底层，我们使用 `process.send` 方法。

```ts
import app from '@adonisjs/core/services/app'

app.notify('ready')

app.notify({
  isReady: true,
  port: 3333,
  host: 'localhost'
})
```

## 生成项目文件的 URL 和路径 (Making URLs and paths to project files)

与其自行构建绝对 URL 或项目文件的路径，我们强烈建议使用以下辅助方法。

### makeURL

`makeURL` 方法返回项目根目录下给定文件或目录的文件 URL。例如，您可以在导入文件时生成 URL。

```ts
import app from '@adonisjs/core/services/app'

const files = [
  './tests/welcome.spec.ts',
  './tests/maths.spec.ts'
]

await Promise.all(files.map((file) => {
  return import(app.makeURL(file).href)
}))
```

### makePath

`makePath` 方法返回项目根目录下给定文件或目录的绝对路径。

```ts
import app from '@adonisjs/core/services/app'

app.makePath('app/middleware/auth.ts')
```

### configPath

返回项目 `config` (配置) 目录下的文件路径。

```ts
app.configPath('shield.ts')
// /project_root/config/shield.ts

app.configPath()
// /project_root/config
```

### publicPath

返回项目 `public` (公共) 目录下的文件路径。

```ts
app.publicPath('style.css')
// /project_root/public/style.css

app.publicPath()
// /project_root/public
```

### providersPath

返回 `providers` (提供者) 目录下的文件路径。

```ts
app.providersPath('app_provider')
// /project_root/providers/app_provider.ts

app.providersPath()
// /project_root/providers
```

### factoriesPath

返回数据库 `factories` (工厂) 目录下的文件路径。

```ts
app.factoriesPath('user.ts')
// /project_root/database/factories/user.ts

app.factoriesPath()
// /project_root/database/factories
```

### migrationsPath

返回数据库 `migrations` (迁移) 目录下的文件路径。

```ts
app.migrationsPath('user.ts')
// /project_root/database/migrations/user.ts

app.migrationsPath()
// /project_root/database/migrations
```

### seedersPath

返回数据库 `seeders` (填充器) 目录下的文件路径。

```ts
app.seedersPath('user.ts')
// /project_root/database/seeders/users.ts

app.seedersPath()
// /project_root/database/seeders
```

### languageFilesPath

返回 `languages` (语言) 目录下的文件路径。

```ts
app.languageFilesPath('en/messages.json')
// /project_root/resources/lang/en/messages.json

app.languageFilesPath()
// /project_root/resources/lang
```

### viewsPath

返回 `views` (视图) 目录下的文件路径。

```ts
app.viewsPath('welcome.edge')
// /project_root/resources/views/welcome.edge

app.viewsPath()
// /project_root/resources/views
```

### startPath

返回 `start` 目录下的文件路径。

```ts
app.startPath('routes.ts')
// /project_root/start/routes.ts

app.startPath()
// /project_root/start
```

### tmpPath

返回项目根目录内 `tmp` 目录下的文件路径。

```ts
app.tmpPath('logs/mail.txt')
// /project_root/tmp/logs/mail.txt

app.tmpPath()
// /project_root/tmp
```

### httpControllersPath

返回 HTTP `controllers` (控制器) 目录下的文件路径。

```ts
app.httpControllersPath('users_controller.ts')
// /project_root/app/controllers/users_controller.ts

app.httpControllersPath()
// /project_root/app/controllers
```

### modelsPath

返回 `models` (模型) 目录下的文件路径。

```ts
app.modelsPath('user.ts')
// /project_root/app/models/user.ts

app.modelsPath()
// /project_root/app/models
```

### servicesPath

返回 `services` (服务) 目录下的文件路径。

```ts
app.servicesPath('user.ts')
// /project_root/app/services/user.ts

app.servicesPath()
// /project_root/app/services
```

### exceptionsPath

返回 `exceptions` (异常) 目录下的文件路径。

```ts
app.exceptionsPath('handler.ts')
// /project_root/app/exceptions/handler.ts

app.exceptionsPath()
// /project_root/app/exceptions
```

### mailsPath

返回 `mails` (邮件) 目录下的文件路径。

```ts
app.mailsPath('verify_email.ts')
// /project_root/app/mails/verify_email.ts

app.mailsPath()
// /project_root/app/mails
```

### middlewarePath

返回 `middleware` (中间件) 目录下的文件路径。

```ts
app.middlewarePath('auth.ts')
// /project_root/app/middleware/auth.ts

app.middlewarePath()
// /project_root/app/middleware
```

### policiesPath

返回 `policies` (策略) 目录下的文件路径。

```ts
app.policiesPath('posts.ts')
// /project_root/app/polices/posts.ts

app.policiesPath()
// /project_root/app/polices
```

### validatorsPath

返回 `validators` (验证器) 目录下的文件路径。

```ts
app.validatorsPath('create_user.ts')
// /project_root/app/validators/create_user.ts

app.validatorsPath()
// /project_root/app/validators/create_user.ts
```

### commandsPath

返回 `commands` (命令) 目录下的文件路径。

```ts
app.commandsPath('greet.ts')
// /project_root/commands/greet.ts

app.commandsPath()
// /project_root/commands
```

### eventsPath

返回 `events` (事件) 目录下的文件路径。

```ts
app.eventsPath('user_created.ts')
// /project_root/app/events/user_created.ts

app.eventsPath()
// /project_root/app/events
```

### listenersPath

返回 `listeners` (监听器) 目录下的文件路径。

```ts
app.listenersPath('send_invoice.ts')
// /project_root/app/listeners/send_invoice.ts

app.listenersPath()
// /project_root/app/listeners
```

## 生成器 (Generators)

生成器用于为不同的实体创建类名和文件名。例如，您可以使用 `generators.controllerFileName` 方法生成控制器的文件名。

```ts
import app from '@adonisjs/core/services/app'

app.generators.controllerFileName('user')
// 输出 - users_controller.ts

app.generators.controllerName('user')
// 输出 - UsersController
```

请[参考 `generators.ts` 源代码](https://www.google.com/search?q=%5Bhttps://github.com/adonisjs/application/blob/main/src/generators.ts)以查看可用生成器的列表](https://www.google.com/search?q=https://github.com/adonisjs/application/blob/main/src/generators.ts)%E4%BB%A5%E6%9F%A5%E7%9C%8B%E5%8F%AF%E7%94%A8%E7%94%9F%E6%88%90%E5%99%A8%E7%9A%84%E5%88%97%E8%A1%A8)。