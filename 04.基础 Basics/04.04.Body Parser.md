# 请求体解析中间件 (Body parser middleware)

请求数据是使用注册在 `start/kernel.ts` 文件中的 **`BodyParser` 中间件**进行解析的。

该中间件的配置存储在 **`config/bodyparser.ts` 文件**中。在这个文件中，您可以配置用于解析 **JSON 有效载荷**、**包含文件上传的多部分表单**和 **URL 编码表单**的解析器。

另请参阅：[读取请求体](https://www.google.com/search?q=./request.md%23request-body)  
另请参阅：[文件上传](https://www.google.com/search?q=./file_uploads.md)

```ts
import { defineConfig } from '@adonisjs/core/bodyparser'

export const defineConfig({
  // 允许解析请求体的方法
  allowedMethods: ['POST', 'PUT', 'PATCH', 'DELETE'],

  form: {
    // 解析 HTML 表单的设置
  },

  json: {
    // 解析 JSON 请求体的设置
  },

  multipart: {
    // 多部分解析器的设置（用于文件上传）
  },

  raw: {
    // 原始文本解析器的设置
  },
})
```

-----

## 允许的方法 (Allowed methods)

您可以定义一个 `allowedMethods` 数组，**`BodyParser` 中间件**应该尝试为这些方法解析请求体。默认情况下，配置了以下方法。不过，您可以随意删除或添加新方法。

```ts
{
  allowedMethods: ['POST', 'PUT', 'PATCH', 'DELETE']
}
```

-----

## 将空字符串转换为 null (Converting empty strings to null)

当输入字段没有值时，HTML 表单会在请求体中发送**空字符串**。HTML 表单的这种行为使得**数据库层的数据规范化**更加困难。

例如，如果您有一个数据库列 `country` 设置为可为空 (nullable)，您可能希望在用户未选择国家/地区时，在该列中存储 **`null`** 作为值。

然而，对于 HTML 表单，后端接收到的是一个**空字符串**，您可能会将空字符串插入到数据库中，而不是将该列留作 `null`。

当配置中启用 **`convertEmptyStringsToNull` 标志**时，`BodyParser` 中间件可以处理这种不一致性，将所有空字符串值转换为 **`null`**。

```ts
{
  form: {
    // ... rest of the config
    convertEmptyStringsToNull: true
  },

  json: {
    // ... rest of the config
    convertEmptyStringsToNull: true
  },

  multipart: {
    // ... rest of the config
    convertEmptyStringsToNull: true
  }
}
```

-----

## JSON 解析器 (JSON parser)

**JSON 解析器**用于解析定义为 **JSON 编码字符串**且 `Content-type` 标头匹配预定义 `types` 值之一的请求体。

```ts
json: {
  encoding: 'utf-8',
  limit: '1mb',
  strict: true,
  types: [
    'application/json',
    'application/json-patch+json',
    'application/vnd.api+json',
    'application/csp-report',
  ],
  convertEmptyStringsToNull: true,
}
```

\<dl\>

\<dt\>

**encoding (编码)**

\</dt\>

\<dd\>

将请求体 Buffer 转换为字符串时使用的编码。您很可能希望使用 **`utf-8`**。不过，您可以使用 [iconv-lite 包](https://www.npmjs.com/package/iconv-lite#readme) 支持的任何编码。

\</dd\>

\<dt\>

**limit (限制)**

\</dt\>

\<dd\>

解析器应允许的请求体数据的最大限制。如果请求体超过配置的限制，将返回 **`413` 错误**。

\</dd\>

\<dt\>

**strict (严格模式)**

\</dt\>

\<dd\>

严格解析只允许 **`objects`** 和 **`arrays`** 位于 JSON 编码字符串的顶层。

\</dd\>

\<dt\>

**types (类型)**

\</dt\>

\<dd\>

`Content-type` 标头的值数组，应使用 JSON 解析器进行解析。

\</dd\>

\</dl\>

-----

## URL 编码表单解析器 (URL encoded form parser)

**`form` 解析器**用于解析 URL 编码字符串，其中 `Content-type` 标头设置为 **`application/x-www-form-urlencoded`**。换句话说，**HTML 表单数据**是使用 `form` 解析器进行解析的。

```ts
form: {
  encoding: 'utf-8',
  limit: '1mb',
  queryString: {},
  types: ['application/x-www-form-urlencoded'],
  convertEmptyStringsToNull: true,
}
```

\<dl\>

\<dt\>

**encoding (编码)**

\<dt\>

\<dd\>

将请求体 Buffer 转换为字符串时使用的编码。您很可能希望使用 **`utf-8`**。不过，您可以使用 [iconv-lite 包](https://www.npmjs.com/package/iconv-lite#readme) 支持的任何编码。

\</dd\>

\<dt\>

**limit (限制)**

\<dt\>

\<dd\>

解析器应允许的请求体数据的最大限制。如果请求体超过配置的限制，将返回 **`413` 错误**。

\</dd\>

\<dt\>

**queryString (查询字符串)**

\<dt\>

\<dd\>

URL 编码的请求体是使用 [qs 包](https://www.npmjs.com/package/qs) 进行解析的。您可以使用 **`queryString` 属性**定义该包的选项。

```ts
  form: {
    queryString: {
      allowDots: true, // 允许使用点（.）
      allowSparse: true, // 允许稀疏数组
    },
  }
```

\</dd\>

\</dl\>

-----

## 多部分解析器 (Multipart parser)

**`multipart` 解析器**用于解析**带有文件上传的 HTML 表单请求**。

另请参阅：[文件上传](https://www.google.com/search?q=./file_uploads.md)

```ts
multipart: {
  autoProcess: true,
  processManually: [],
  encoding: 'utf-8',
  fieldsLimit: '2mb',
  limit: '20mb',
  types: ['multipart/form-data'],
  convertEmptyStringsToNull: true,
}
```

\<dl\>

\<dt\>

**autoProcess (自动处理)**

\</dt\>

\<dd\>

启用 **`autoProcess`** 将把所有用户上传的文件**移动到操作系统的 `tmp` 目录**中。

稍后，在控制器内部，您可以验证文件并将其移动到永久位置或云服务。

如果您禁用 `autoProcess` 标志，则必须**手动处理流**并从请求体中读取文件/字段。另请参阅：[自处理多部分流](https://www.google.com/search?q=./file_uploads.md%23self-processing-multipart-stream)。

您可以定义一个**路由数组**，对这些路由自动处理文件。这些值**必须是路由模式 (route pattern)**，而不是 URL。

```ts
{
  autoProcess: [
    '/uploads',
    '/post/:id'
  ]
}
```

\</dd\>

\<dt\>

**processManually (手动处理)**

\</dt\>

\<dd\>

**`processManually` 数组**允许您**关闭**对选定路由的文件自动处理。这些值**必须是路由模式**，而不是 URL。

```ts
multipart: {
  autoProcess: true,
  processManually: [
    '/file_manager',
    '/projects/:id/assets'
  ],
}
```

\</dd\>

\<dt\>

**encoding (编码)**

\</dt\>

\<dd\>

将请求体 Buffer 转换为字符串时使用的编码。您很可能希望使用 **`utf-8`**。不过，您可以使用 [iconv-lite 包](https://www.npmjs.com/package/iconv-lite#readme) 支持的任何编码。

\</dd\>

\<dt\>

**limit (总限制)**

\</dt\>

\<dd\>

处理**所有文件**时允许的最大字节限制。您可以使用 [request.file](https://www.google.com/search?q=./file_uploads.md) 方法定义**单个文件**的大小限制。

\</dd\>

\<dt\>

**fieldsLimit (字段限制)**

\</dt\>

\<dd\>

处理多部分请求时，允许用于**字段（非文件）** 的最大字节限制。如果字段大小超过配置的限制，将返回 **`413` 错误**。

\</dd\>

\</dl\>
